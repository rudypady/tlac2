// üöÄ PROFESION√ÅLNY SYST√âM TLAƒåENIA ≈†T√çTKOV

// Glob√°lne premenn√© pre ulo≈æenie stavu aplik√°cie
let database = []; // Pole objektov pre datab√°zu produktov (naƒç√≠tan√© z data.xlsm, zmeny v localStorage)
let labels = []; // Pole objektov pre ≈°t√≠tky pripraven√© na tlaƒç (lok√°lne pre aktu√°lnu rel√°ciu, v≈ædy v localStorage)
let printHistory = []; // Hist√≥ria tlaƒçe (lok√°lne v localStorage)
let printSets = {}; // Ulo≈æen√© tlaƒçov√© sady (lok√°lne v localStorage)
let labelIdCounter = 1; // Poƒç√≠tadlo pre unik√°tne ID ≈°t√≠tkov
let searchTimeout = null; // Pre debounce funkciu vyhƒæad√°vania
let currentTheme = 'light'; // Aktu√°lna t√©ma ('light', 'dark', 'auto')
let currentLanguage = 'sk'; // Aktu√°lny jazyk ('sk', 'en', 'de')
let showLogo = false; // Zobrazi≈• logo na ≈°t√≠tkoch - ZMENEN√â NA FALSE PODƒΩA PO≈ΩIADAVKY
let currentTemplate = 'default'; // Aktu√°lna ≈°abl√≥na ≈°t√≠tka

// Preklady pre r√¥zne jazyky
const translations = {
    sk: {
        'title': 'Tlaƒçenie ≈°t√≠tkov PRO',
        'subtitle': 'Profesion√°lny syst√©m pre Schaeffler',
        'tab-labels': '≈†t√≠tky',
        'tab-history': 'Hist√≥ria tlaƒçe',
        'tab-settings': 'Nastavenia',
        'search-title': 'Vyhƒæada≈• v datab√°ze',
        'search-placeholder': 'Zadajte artikel, n√°zov alebo policu... (M√¥≈æete pou≈æi≈•: polica:A1, nazov:"text", artikel:123)',
        'filter-all': 'V≈°etko',
        'filter-location': 'Umiestnenie',
        'no-results': '≈Ωiadne v√Ωsledky',
        'quick-label': 'R√Ωchly ≈°t√≠tok',
        'label-artikel': 'Artikel',
        'label-name': 'N√°zov',
        'label-shelf': 'Polica',
        'btn-add-print': 'Prida≈• na tlaƒç',
        'btn-save-print': 'Ulo≈æi≈• + tlaƒç', // Ponechan√© v prekladoch, ale tlaƒçidlo je odstr√°nen√©
        'preview-title': 'N√°hƒæad ≈°t√≠tka (2" x 1")',
        'template-default': '≈†tandardn√Ω',
        'template-compact': 'Kompaktn√Ω',
        'template-detailed': 'Detailn√Ω',
        'labels-title': '≈†t√≠tky na tlaƒç',
        'labels-count-suffix': '≈°t√≠tkov',
        'btn-preview': 'N√°hƒæad tlaƒçe',
        'btn-print': 'Tlaƒçi≈•',
        'btn-export-pdf': 'Exportova≈• PDF',
        'empty-title': 'Zatiaƒæ ≈æiadne ≈°t√≠tky na tlaƒç',
        'empty-desc': 'Vyhƒæadajte produkt alebo pridajte r√Ωchly ≈°t√≠tok',
        'stats-title': '≈†tatistiky',
        'stat-total': 'Poƒçet artiklov v datab√°ze',
        'stat-today': 'Dnes', // Ponechan√© v prekladoch, ale √∫daj je odstr√°nen√Ω
        'chart-title': 'Graf kateg√≥ri√≠', // Ponechan√© v prekladoch, ale graf je odstr√°nen√Ω
        'shortcuts-title': 'Kl√°vesov√© skratky', // Ponechan√© v prekladoch, ale sekcia je odstr√°nen√°
        'shortcut-search': 'Vyhƒæad√°vanie',
        'shortcut-add': 'Prida≈• ≈°t√≠tok',
        'shortcut-print': 'Tlaƒçi≈•',
        'shortcut-theme': 'Zmena t√©my',
        'db-management': 'Spr√°va datab√°zy',
        'quick-actions': 'R√Ωchle akcie',
        'btn-clear': 'Vymaza≈• DB',
        'import-files': 'Import s√∫borov',
        'drop-text': 'Pretiahnite s√∫bory sem alebo kliknite pre v√Ωber (data.xlsm pre datab√°zu)',
        'btn-import': 'Importova≈• s√∫bory',
        'bulk-upload': 'Hromadn√© nahr√°vanie (text)',
        'bulk-format': 'Form√°t: Artikel;N√°zov;Polica',
        'btn-bulk': 'Nahra≈• hromadne',
        'add-single': 'Prida≈• jednotlivo',
        'btn-add-db': 'Prida≈• do datab√°zy',
        'db-preview': 'Datab√°za (n√°hƒæad)',
        'loading': 'Naƒç√≠tavam...',
        'reports-title': 'Reporty a ≈°tatistiky',
        'btn-generate': 'Generova≈• report',
        'btn-export-report': 'Exportova≈• report',
        'settings-title': 'Nastavenia',
        'setting-theme': 'T√©ma vzhƒæadu',
        'theme-light': 'Svetl√°',
        'theme-dark': 'Tmav√°',
        'theme-auto': 'Automatick√°',
        'setting-lang': 'Jazyk',
        'setting-logo': 'Logo na ≈°t√≠tkoch',
        'logo-show': 'Zobrazi≈•',
        'logo-hide': 'Skry≈•',
        'setting-template': 'Predvolen√° ≈°abl√≥na',
        'btn-save-settings': 'Ulo≈æi≈• nastavenia',
        'history-title': 'Hist√≥ria tlaƒçe',
        'btn-clear-history': 'Vymaza≈• hist√≥riu',
        'btn-export-history': 'Exportova≈• hist√≥riu',
        'stat-total-printed': 'Celkom vytlaƒçen√Ωch ≈°t√≠tkov',
        'stat-print-sessions': 'Rel√°ci√≠ tlaƒçe',
        'history-filter-placeholder': 'Filtrova≈• hist√≥riu...',
        'no-history': 'Zatiaƒæ ≈æiadna hist√≥ria tlaƒçe...',
        'history-printed-at': 'Vytlaƒçen√©',
        'history-labels-count': '≈°t√≠tkov',
        'confirm-clear-history': 'Naozaj chcete vymaza≈• cel√∫ hist√≥riu tlaƒçe?',
        'btn-save-set': 'Ulo≈æi≈• sadu',
        'btn-load-set': 'Naƒç√≠ta≈• sadu',
        'btn-delete-set': 'Zmaza≈• sadu',
        'select-print-set': 'Vyberte tlaƒçov√∫ sadu...',
        'toast-success-save-set': 'Tlaƒçov√° sada bola √∫spe≈°ne ulo≈æen√°!',
        'toast-success-load-set': 'Tlaƒçov√° sada bola √∫spe≈°ne naƒç√≠tan√°!',
        'toast-success-delete-set': 'Tlaƒçov√° sada bola √∫spe≈°ne zmazan√°!',
        'toast-error-set-name': 'Zadajte n√°zov tlaƒçovej sady!',
        'toast-error-no-labels-save': '≈Ωiadne ≈°t√≠tky na ulo≈æenie do sady!',
        'toast-error-no-set-selected': 'Vyberte tlaƒçov√∫ sadu na naƒç√≠tanie!',
        'confirm-delete-set': 'Naozaj chcete zmaza≈• t√∫to tlaƒçov√∫ sadu?',
        'select-all-labels': 'Oznaƒçi≈• v≈°etky',
        'btn-bulk-delete': 'Zmaza≈• oznaƒçen√©',
        'btn-bulk-quantity': 'Zmeni≈• mno≈æstvo',
        'bulk-selected-count': 'oznaƒçen√Ωch',
        'bulk-change-quantity': 'Nov√© mno≈æstvo pre oznaƒçen√© ≈°t√≠tky:',
        'toast-success-bulk-delete': 'Oznaƒçen√© ≈°t√≠tky boli zmazan√©!',
        'toast-success-bulk-quantity': 'Mno≈æstvo bolo zmenen√©!',
        'toast-error-no-selection': '≈Ωiadne ≈°t√≠tky nie s√∫ oznaƒçen√©!',
        'toast-error-invalid-quantity': 'Zadajte platn√© mno≈æstvo!',
        'confirm-bulk-delete': 'Naozaj chcete zmaza≈• oznaƒçen√© ≈°t√≠tky?',
        'preview-modal-title': 'N√°hƒæad tlaƒçe',
        'btn-print-now': 'Tlaƒçi≈• teraz',
        'toast-success-add-label': '≈†t√≠tok bol √∫spe≈°ne pridan√Ω na tlaƒç!',
        'toast-success-save-label': '≈†t√≠tok bol √∫spe≈°ne ulo≈æen√Ω a pridan√Ω na tlaƒç!',
        'toast-success-db-add': 'Polo≈æka bola √∫spe≈°ne pridan√° do datab√°zy!',
        'toast-success-db-update': 'Polo≈æka bola √∫spe≈°ne aktualizovan√° v datab√°ze!',
        'toast-success-db-delete': 'Polo≈æka bola √∫spe≈°ne odstr√°nen√° z datab√°zy!',
        'toast-success-import': 'D√°ta boli √∫spe≈°ne importovan√©!',
        'toast-success-export': 'D√°ta boli √∫spe≈°ne exportovan√©!',
        'toast-success-clear-db': 'Datab√°za bola √∫spe≈°ne vymazan√°!',
        'toast-success-settings': 'Nastavenia boli √∫spe≈°ne ulo≈æen√©!',
        'toast-error-import': 'Chyba pri importe s√∫boru. Skontrolujte form√°t.',
        'toast-error-barcode': 'Chyba pri generovan√≠ ƒçiarov√©ho k√≥du. Artikel mus√≠ by≈• platn√Ω.',
        'toast-error-invalid-artikel': 'Neplatn√Ω artikel! Povolen√© s√∫ len ƒç√≠sla vo form√°te 123456789-0000 alebo 1234567890000.',
        'toast-error-bulk': 'Chyba pri hromadnom nahr√°van√≠. Skontrolujte form√°t riadkov.',
        'toast-error-db-add': 'Chyba pri prid√°van√≠ polo≈æky do datab√°zy. Skontrolujte vstupy.',
        'toast-error-db-update': 'Chyba pri aktualiz√°cii polo≈æky v datab√°zy.',
        'toast-error-db-delete': 'Chyba pri odstra≈àovan√≠ polo≈æky z datab√°zy.',
        'toast-warning-no-labels': '≈Ωiadne ≈°t√≠tky na tlaƒç!',
        'toast-warning-no-data': '≈Ωiadne d√°ta v datab√°ze na export!',
        'confirm-clear-db': 'Naozaj chcete vymaza≈• cel√∫ datab√°zu? T√°to akcia je nevratn√°!',
        'confirm-delete-item': 'Naozaj chcete odstr√°ni≈• t√∫to polo≈æku z datab√°zy?',
        'db-filter-placeholder': 'Filtrova≈• datab√°zu...',
        'report-total-items': 'Celkov√Ω poƒçet polo≈æiek',
        'report-items-today': 'Polo≈æky pridan√© dnes',
        'report-items-per-shelf': 'Polo≈æky podƒæa police',
        'report-average-name-length': 'Priemern√° dƒ∫≈æka n√°zvu',
        'btn-save-db': 'Aktualizova≈• v datab√°ze',
        'quantity-label': 'Mno≈æstvo:',
        'unsupported-format': 'Nepodporovan√Ω form√°t',
        'missing-data-import': 'Ch√Ωbaj√∫ce d√°ta v importovanom riadku.',
        'large-import-success': '√öspe≈°ne spracovan√Ωch {count} polo≈æiek.',
        'processing-items': 'Spracov√°vam {count} polo≈æiek...',
        'local-storage-limit-warning': 'Upozornenie: Lok√°lne √∫lo≈æisko prehliadaƒça m√¥≈æe ma≈• obmedzen√∫ kapacitu (zvyƒçajne 5-10 MB). Pre veƒæmi veƒæk√© datab√°zy (napr. 100 000 artiklov) m√¥≈æe nasta≈• probl√©m s ukladan√≠m v≈°etk√Ωch d√°t. Zv√°≈æte export d√°t pre z√°lohovanie.',
        'import-skipped-rows': ' (Preskoƒçen√Ωch {count} riadkov kv√¥li ch√Ωbaj√∫cim d√°tam.)',
        'import-all-skipped': '≈Ωiadne d√°ta neboli importovan√©. Preskoƒçen√Ωch {count} riadkov kv√¥li ch√Ωbaj√∫cim d√°tam.',
        'database-not-loaded': 'Datab√°za nie je naƒç√≠tan√°. Nahrajte s√∫bor data.xlsm cez import s√∫borov.',
        // Name tag specific translations
        'name-tag-name-label': 'Meno',
        'name-tag-surname-label': 'Priezvisko',
        'name-tag-personal-number-label': 'Osobn√© ƒç√≠slo',
        'name-tag-department-label': 'Oddelenie (voliteƒæn√©)',
        'name-tag-name-placeholder': 'J√°n',
        'name-tag-surname-placeholder': 'Nov√°k',
        'name-tag-personal-number-placeholder': '1234567890',
        'name-tag-department-placeholder': 'IT Podpora',
        'name-tag-preview-title': 'N√°hƒæad menovky',
        'name-tag-help-desc': 'Zadajte meno, priezvisko a osobn√© ƒç√≠slo zamestnanca. ƒåiarov√Ω k√≥d sa vygeneruje z osobn√©ho ƒç√≠sla.',
        'name-tag-example-name': 'Meno',
        'name-tag-example-surname': 'Priezvisko',
        'name-tag-example-personal-number': 'Osobn√© ƒç√≠slo',
        'name-tag-example-department': 'Oddelenie',
        'name-tag-example-barcode': 'ƒåiarov√Ω k√≥d',
        'name-tag-help-note': 'Osobn√© ƒç√≠slo sl√∫≈æi ako identifik√°tor a generuje sa do ƒçiarov√©ho k√≥du. Oddelenie je voliteƒæn√©.',
        'shelf-preview-title': 'N√°hƒæad ≈°t√≠tka police'
    },
    en: {
        'title': 'Label Printing System PRO',
        'subtitle': 'Professional System for Schaeffler',
        'tab-labels': 'Labels',
        'tab-database': 'Database',
        'tab-settings': 'Settings',
        'search-title': 'Search Database',
        'search-placeholder': 'Enter article, name or shelf...',
        'filter-all': 'All',
        'filter-location': 'Location',
        'no-results': 'No results',
        'quick-label': 'Quick Label',
        'label-artikel': 'Article',
        'label-name': 'Name',
        'label-shelf': 'Shelf',
        'btn-add-print': 'Add to Print',
        'btn-save-print': 'Save + Print',
        'preview-title': 'Label Preview (2" x 1")',
        'template-default': 'Standard',
        'template-compact': 'Compact',
        'template-detailed': 'Detailed',
        'labels-title': 'Labels to Print',
        'labels-count-suffix': 'labels',
        'btn-preview': 'Print Preview',
        'btn-print': 'Print',
        'btn-export-pdf': 'Export PDF',
        'empty-title': 'No labels to print yet',
        'empty-desc': 'Search for a product or add a quick label',
        'stats-title': 'Statistics',
        'stat-total': 'Total',
        'stat-today': 'Today',
        'chart-title': 'Category Chart',
        'shortcuts-title': 'Keyboard Shortcuts',
        'shortcut-search': 'Search',
        'shortcut-add': 'Add Label',
        'shortcut-print': 'Print',
        'shortcut-theme': 'Change Theme',
        'db-management': 'Database Management',
        'quick-actions': 'Quick Actions',
        'btn-clear': 'Clear DB',
        'import-files': 'Import Files',
        'drop-text': 'Drag files here or click to select (data.xlsm for database)',
        'btn-import': 'Import Files',
        'bulk-upload': 'Bulk Upload (text)',
        'bulk-format': 'Format: Article;Name;Shelf',
        'btn-bulk': 'Upload Bulk',
        'add-single': 'Add Individually',
        'btn-add-db': 'Add to Database',
        'db-preview': 'Database (Preview)',
        'loading': 'Loading...',
        'reports-title': 'Reports & Statistics',
        'btn-generate': 'Generate Report',
        'btn-export-report': 'Export Report',
        'settings-title': 'Settings',
        'setting-theme': 'Appearance Theme',
        'theme-light': 'Light',
        'theme-dark': 'Dark',
        'theme-auto': 'Auto',
        'setting-lang': 'Language',
        'setting-logo': 'Logo on Labels',
        'logo-show': 'Show',
        'logo-hide': 'Hide',
        'setting-template': 'Default Template',
        'btn-save-settings': 'Save Settings',
        'preview-modal-title': 'Print Preview',
        'btn-print-now': 'Print Now',
        'toast-success-add-label': 'Label successfully added for printing!',
        'toast-success-save-label': 'Label successfully saved and added for printing!',
        'toast-success-db-add': 'Item successfully added to database!',
        'toast-success-db-update': 'Item successfully updated in database!',
        'toast-success-db-delete': 'Item successfully deleted from database!',
        'toast-success-import': 'Data successfully imported!',
        'toast-error-barcode': 'Error generating barcode. Article must be valid.',
        'toast-error-bulk': 'Error in bulk upload. Check line format.',
        'toast-error-db-add': 'Error adding item to database. Check inputs.',
        'toast-error-db-update': 'Error updating item in database.',
        'toast-error-db-delete': 'Error deleting item from database.',
        'toast-warning-no-labels': 'No labels to print!',
        'toast-warning-no-data': 'No data in database to export!',
        'confirm-clear-db': 'Are you sure you want to clear the entire database? This action is irreversible!',
        'confirm-delete-item': 'Are you sure you want to delete this item from the database?',
        'db-filter-placeholder': 'Filter database...',
        'report-total-items': 'Total Items',
        'report-items-today': 'Items Added Today',
        'report-items-per-shelf': 'Items by Shelf',
        'report-average-name-length': 'Average Name Length',
        'btn-save-db': 'Update in database',
        'quantity-label': 'Quantity:',
        'unsupported-format': 'Unsupported format',
        'missing-data-import': 'Missing data in imported row.',
        'large-import-success': 'Successfully processed {count} items.',
        'processing-items': 'Processing {count} items...',
        'local-storage-limit-warning': 'Warning: Browser local storage may have limited capacity (typically 5-10 MB). For very large databases (e.g., 100,000 articles), there might be issues with storing all data. Consider exporting data for backup.',
        'import-skipped-rows': ' ({count} rows skipped due to missing data.)',
        'import-all-skipped': 'No data imported. {count} rows skipped due to missing data.',
        'database-not-loaded': 'Database not loaded. Upload data.xlsm file via file import.',
        // Name tag specific translations
        'name-tag-name-label': 'Name',
        'name-tag-surname-label': 'Surname',
        'name-tag-personal-number-label': 'Personal Number',
        'name-tag-department-label': 'Department (optional)',
        'name-tag-name-placeholder': 'John',
        'name-tag-surname-placeholder': 'Smith',
        'name-tag-personal-number-placeholder': '1234567890',
        'name-tag-department-placeholder': 'IT Support',
        'name-tag-preview-title': 'Name Tag Preview',
        'name-tag-help-desc': 'Enter employee name, surname and personal number. Barcode will be generated from the personal number.',
        'name-tag-example-name': 'Name',
        'name-tag-example-surname': 'Surname',
        'name-tag-example-personal-number': 'Personal Number',
        'name-tag-example-department': 'Department',
        'name-tag-example-barcode': 'Barcode',
        'name-tag-help-note': 'Personal number serves as identifier and is generated into barcode. Department is optional.',
        'shelf-preview-title': 'Shelf Label Preview'
    },
    de: {
        'title': 'Etikettendrucksystem PRO',
        'subtitle': 'Professionelles System f√ºr Schaeffler',
        'tab-labels': 'Etiketten',
        'tab-database': 'Datenbank',
        'tab-settings': 'Einstellungen',
        'search-title': 'Datenbank durchsuchen',
        'search-placeholder': 'Artikel, Name oder Regal eingeben...',
        'filter-all': 'Alle',
        'filter-location': 'Standort',
        'no-results': 'Keine Ergebnisse',
        'quick-label': 'Schnelles Etikett',
        'label-artikel': 'Artikel',
        'label-name': 'Name',
        'label-shelf': 'Regal',
        'btn-add-print': 'Zum Druck hinzuf√ºgen',
        'btn-save-print': 'Speichern + Drucken',
        'preview-title': 'Etikettenvorschau (2" x 1")',
        'template-default': 'Standard',
        'template-compact': 'Kompakt',
        'template-detailed': 'Detailliert',
        'labels-title': 'Etiketten zum Drucken',
        'labels-count-suffix': 'Etiketten',
        'btn-preview': 'Druckvorschau',
        'btn-print': 'Drucken',
        'btn-export-pdf': 'PDF Exportieren',
        'empty-title': 'Noch keine Etiketten zum Drucken',
        'empty-desc': 'Produkt suchen oder schnelles Etikett hinzuf√ºgen',
        'stats-title': 'Statistiken',
        'stat-total': 'Gesamt',
        'stat-today': 'Heute',
        'chart-title': 'Kategorien-Diagramm',
        'shortcuts-title': 'Tastenk√ºrzel',
        'shortcut-search': 'Suche',
        'shortcut-add': 'Etikett hinzuf√ºgen',
        'shortcut-print': 'Drucken',
        'shortcut-theme': 'Thema wechseln',
        'db-management': 'Datenbankverwaltung',
        'quick-actions': 'Schnelle Aktionen',
        'btn-clear': 'DB leeren',
        'import-files': 'Dateien importieren',
        'drop-text': 'Dateien hierher ziehen oder klicken zum Ausw√§hlen (data.xlsm f√ºr Datenbank)',
        'btn-import': 'Dateien importieren',
        'bulk-upload': 'Massen-Upload (Text)',
        'bulk-format': 'Format: Artikel;Name;Regal',
        'btn-bulk': 'Massen-Upload',
        'add-single': 'Einzeln hinzuf√ºgen',
        'btn-add-db': 'Zur Datenbank hinzuf√ºgen',
        'db-preview': 'Datenbank (Vorschau)',
        'loading': 'Laden...',
        'reports-title': 'Berichte & Statistiken',
        'btn-generate': 'Bericht generieren',
        'btn-export-report': 'Export Bericht',
        'settings-title': 'Einstellungen',
        'setting-theme': 'Erscheinungsbild Thema',
        'theme-light': 'Hell',
        'theme-dark': 'Dunkel',
        'theme-auto': 'Automatisch',
        'setting-lang': 'Sprache',
        'setting-logo': 'Logo auf Etiketten',
        'logo-show': 'Anzeigen',
        'logo-hide': 'Ausblenden',
        'setting-template': 'Standardvorlage',
        'btn-save-settings': 'Einstellungen speichern',
        'preview-modal-title': 'Druckvorschau',
        'btn-print-now': 'Jetzt drucken',
        'toast-success-add-label': 'Etikett erfolgreich zum Drucken hinzugef√ºgt!',
        'toast-success-save-label': 'Etikett erfolgreich gespeichert und zum Drucken hinzugef√ºgt!',
        'toast-success-db-add': 'Element erfolgreich zur Datenbank hinzugef√ºgt!',
        'toast-success-db-update': 'Element erfolgreich in der Datenbank aktualisiert!',
        'toast-success-db-delete': 'Element erfolgreich aus der Datenbank gel√∂scht!',
        'toast-success-import': 'Daten erfolgreich importiert!',
        'toast-error-barcode': 'Fehler beim Generieren des Barcodes. Artikel muss g√ºltig sein.',
        'toast-error-bulk': 'Fehler im Massen-Upload. Zeilenformat √ºberpr√ºfen.',
        'toast-error-db-add': 'Fehler beim Hinzuf√ºgen des Elements zur Datenbank. Eingaben √ºberpr√ºfen.',
        'toast-error-db-update': 'Fehler beim Aktualisieren des Elements in der Datenbank.',
        'toast-error-db-delete': 'Fehler beim L√∂schen des Elements aus der Datenbank.',
        'toast-warning-no-labels': 'Keine Etiketten zum Drucken!',
        'toast-warning-no-data': 'Keine Daten in der Datenbank zum Exportieren!',
        'confirm-clear-db': 'M√∂chten Sie wirklich die gesamte Datenbank leeren? Diese Aktion ist irreversibel!',
        'confirm-delete-item': 'M√∂chten Sie dieses Element wirklich aus der Datenbank l√∂schen?',
        'db-filter-placeholder': 'Datenbank filtern...',
        'report-total-items': 'Gesamtzahl der Artikel',
        'report-items-today': 'Heute hinzugef√ºgte Artikel',
        'report-items-per-shelf': 'Artikel pro Regal',
        'report-average-name-length': 'Durchschnittliche Namensl√§nge',
        'btn-save-db': 'In Datenbank aktualisieren',
        'quantity-label': 'Menge:',
        'unsupported-format': 'Nicht unterst√ºtztes Format',
        'missing-data-import': 'Fehlende Daten in importierter Zeile.',
        'large-import-success': '{count} Artikel erfolgreich verarbeitet.',
        'processing-items': 'Verarbeite {count} Artikel...',
        'local-storage-limit-warning': 'Warnung: Der lokale Speicher des Browsers hat m√∂glicherweise eine begrenzte Kapazit√§t (typischerweise 5-10 MB). Bei sehr gro√üen Datenbanken (z. B. 100.000 Artikel) kann es zu Problemen beim Speichern aller Daten kommen. Erw√§gen Sie den Export von Daten zur Sicherung.',
        'import-skipped-rows': ' ({count} Zeilen wurden aufgrund fehlender Daten √ºbersprungen.)',
        'import-all-skipped': 'Keine Daten importiert. {count} Zeilen wurden aufgrund fehlender Daten √ºbersprungen.',
        'database-not-loaded': 'Datenbank nicht geladen. Laden Sie die Datei data.xlsm √ºber den Datei-Import hoch.',
        // Name tag specific translations
        'name-tag-name-label': 'Name',
        'name-tag-surname-label': 'Nachname',
        'name-tag-personal-number-label': 'Personalnummer',
        'name-tag-department-label': 'Abteilung (optional)',
        'name-tag-name-placeholder': 'Hans',
        'name-tag-surname-placeholder': 'M√ºller',
        'name-tag-personal-number-placeholder': '1234567890',
        'name-tag-department-placeholder': 'IT Support',
        'name-tag-preview-title': 'Namensschild Vorschau',
        'name-tag-help-desc': 'Namen, Nachnamen und Personalnummer des Mitarbeiters eingeben. Barcode wird aus der Personalnummer generiert.',
        'name-tag-example-name': 'Name',
        'name-tag-example-surname': 'Nachname',
        'name-tag-example-personal-number': 'Personalnummer',
        'name-tag-example-department': 'Abteilung',
        'name-tag-example-barcode': 'Barcode',
        'name-tag-help-note': 'Personalnummer dient als Identifikator und wird in den Barcode generiert. Abteilung ist optional.',
        'shelf-preview-title': 'Regal-Etikett Vorschau'
    }
};

// Z√≠skanie referenci√≠ na DOM elementy
const elements = {
    // Taby
    tabButtons: document.querySelectorAll('.tab'),
    tabContents: document.querySelectorAll('.tab-content'),

    // Hlaviƒçka
    languageSelect: document.getElementById('languageSelect'),
    themeToggle: document.getElementById('themeToggle'),
    themeIcon: document.getElementById('themeIcon'),

    // ≈†t√≠tky (Labels) tab
    searchInput: document.getElementById('searchInput'),
    searchResults: document.getElementById('searchResults'),
    resultsList: document.getElementById('resultsList'),
    filterButtons: document.querySelectorAll('.filter-btn'),
    
    quickArtikel: document.getElementById('quickArtikel'),
    quickNazov: document.getElementById('quickNazov'),
    quickPolica: document.getElementById('quickPolica'),
    addQuickBtn: document.getElementById('addQuickBtn'),

    previewArtikel: document.getElementById('previewArtikel'),
    previewNazov: document.getElementById('previewNazov'),
    previewPolica: document.getElementById('previewPolica'),
    previewBarcode: document.getElementById('previewBarcode'),
    // Odstr√°nen√©: previewLogo: document.getElementById('previewLogo'),
    templateSelect: document.getElementById('templateSelect'),

    labelsCount: document.getElementById('labelsCount'),
    previewBtn: document.getElementById('previewBtn'),
    printBtn: document.getElementById('printBtn'),
    // Odstr√°nen√©: exportPdfBtn: document.getElementById('exportPdfBtn'),
    emptyState: document.getElementById('emptyState'),
    labelsList: document.getElementById('labelsList'),

    // Tlaƒçov√© sady (Print Sets)
    printSetsSection: document.getElementById('printSetsSection'),
    printSetName: document.getElementById('printSetName'),
    savePrintSetBtn: document.getElementById('savePrintSetBtn'),
    printSetsSelect: document.getElementById('printSetsSelect'),
    loadPrintSetBtn: document.getElementById('loadPrintSetBtn'),
    deletePrintSetBtn: document.getElementById('deletePrintSetBtn'),

    // Hromadn√© akcie (Bulk Actions)
    bulkActionsSection: document.getElementById('bulkActionsSection'),
    selectAllLabels: document.getElementById('selectAllLabels'),
    selectedCount: document.getElementById('selectedCount'),
    bulkDeleteBtn: document.getElementById('bulkDeleteBtn'),
    bulkQuantityBtn: document.getElementById('bulkQuantityBtn'),

    totalCount: document.getElementById('totalCount'),

    // Name tag tab elements
    nameTagMeno: document.getElementById('nameTagMeno'),
    nameTagPriezvisko: document.getElementById('nameTagPriezvisko'),
    nameTagOsobneCislo: document.getElementById('nameTagOsobneCislo'),
    nameTagOddelenie: document.getElementById('nameTagOddelenie'),
    addNameTagBtn: document.getElementById('addNameTagBtn'),
    nameTagPreviewPersonalNumber: document.getElementById('nameTagPreviewPersonalNumber'),
    nameTagPreviewFullName: document.getElementById('nameTagPreviewFullName'),
    nameTagPreviewDepartment: document.getElementById('nameTagPreviewDepartment'),
    nameTagPreviewBarcode: document.getElementById('nameTagPreviewBarcode'),

    // Shelf label tab elements  
    shelfFach: document.getElementById('shelfFach'),
    shelfPolica: document.getElementById('shelfPolica'),
    addShelfLabelBtn: document.getElementById('addShelfLabelBtn'),
    shelfPreviewFach: document.getElementById('shelfPreviewFach'),
    shelfPreviewShelfDesc: document.getElementById('shelfPreviewShelfDesc'),
    shelfPreviewShelfLocation: document.getElementById('shelfPreviewShelfLocation'),
    shelfPreviewBarcode: document.getElementById('shelfPreviewBarcode'),

    // Datab√°za (Database) tab
    clearDbBtn: document.getElementById('clearDbBtn'),
    exportCsvBtn: document.getElementById('exportCsvBtn'),
    exportExcelBtn: document.getElementById('exportExcelBtn'),
    exportJsonBtn: document.getElementById('exportJsonBtn'),
    dropZone: document.getElementById('dropZone'),
    fileImport: document.getElementById('fileImport'),
    importFileBtn: document.getElementById('importFileBtn'),
    newArtikel: document.getElementById('newArtikel'),
    newNazov: document.getElementById('newNazov'),
    newPolica: document.getElementById('newPolica'),
    addDatabaseBtn: document.getElementById('addDatabaseBtn'),
    dbSearchInput: document.getElementById('dbSearchInput'),
    databaseList: document.getElementById('databaseList'),

    // Nastavenia (Settings) tab
    themeSelect: document.getElementById('themeSelect'),
    languageSettingSelect: document.getElementById('languageSettingSelect'),
    logoSelect: document.getElementById('logoSelect'),
    defaultTemplateSelect: document.getElementById('defaultTemplateSelect'),
    saveSettingsBtn: document.getElementById('saveSettingsBtn'),

    // Hist√≥ria tlaƒçe (Print History) tab
    printHistoryList: document.getElementById('printHistoryList'),
    historySearchInput: document.getElementById('historySearchInput'),
    clearHistoryBtn: document.getElementById('clearHistoryBtn'),
    exportHistoryBtn: document.getElementById('exportHistoryBtn'),
    totalPrintedLabels: document.getElementById('totalPrintedLabels'),
    totalPrintSessions: document.getElementById('totalPrintSessions'),

    // Mod√°ly a toasty
    printPreviewModal: document.getElementById('printPreviewModal'),
    closePrintPreview: document.getElementById('closePrintPreview'),
    printPreviewContainer: document.getElementById('printPreviewContainer'),
    printArea: document.getElementById('printArea'),
    toast: document.getElementById('toast'),
};

// --- Utility funkcie ---

/**
 * Validuje artikel podƒæa striktn√Ωch pravidiel: len ƒç√≠sla vo form√°te 123456789-0000 alebo 1234567890000.
 * @param {string} artikel - Artikel na valid√°ciu.
 * @returns {boolean} True ak je artikel platn√Ω, false ak nie.
 */
function validateArtikel(artikel) {
    if (!artikel) return false;
    
    // Odstr√°ni v≈°etky pomlƒçky a medzery
    const cleanArtikel = artikel.replace(/[-\s]/g, '');
    
    // Kontrola, ƒçi obsahuje len ƒç√≠sla
    if (!/^\d+$/.test(cleanArtikel)) {
        return false;
    }
    
    // Kontrola dƒ∫≈æky: buƒè presne 13 znakov (123456789-0000) alebo presne 13 znakov (1234567890000)
    return cleanArtikel.length === 13;
}

/**
 * Form√°tuje artikel do form√°tu xxx-xxx-xxx (len prv√Ωch 9 ƒç√≠slic).
 * @param {string} artikel - P√¥vodn√Ω artikel.
 * @returns {string} Form√°tovan√Ω artikel s pomlƒçkami (len prv√Ωch 9 ƒç√≠slic).
 */
function formatArtikel(artikel) {
    if (!artikel) return '';
    
    // Odstr√°ni v≈°etky pomlƒçky a medzery
    const cleanArtikel = artikel.replace(/[-\s]/g, '');
    
    // Vezme len prv√Ωch 9 ƒç√≠slic podƒæa po≈æiadavky
    const first9Digits = cleanArtikel.substring(0, 9);
    
    // Ak je krat≈°√≠ ako 3 znaky, vr√°ti ako je
    if (first9Digits.length <= 3) return first9Digits;
    
    // Ak je krat≈°√≠ ako 6 znakov, prid√° jednu pomlƒçku
    if (first9Digits.length <= 6) {
        return first9Digits.substring(0, 3) + '-' + first9Digits.substring(3);
    }
    
    // Pre 7-9 znakov prid√° dve pomlƒçky vo form√°te xxx-xxx-xxx
    return first9Digits.substring(0, 3) + '-' + 
           first9Digits.substring(3, 6) + '-' + 
           first9Digits.substring(6);
}

/**
 * Form√°tuje artikel pre ƒçiarov√Ω k√≥d v tvare 123456789-0000 (pln√© ƒç√≠slo s pomlƒçkou po 9. znaku).
 * @param {string} artikel - P√¥vodn√Ω artikel.
 * @returns {string} Form√°tovan√Ω artikel pre ƒçiarov√Ω k√≥d.
 */
function formatArtikelForBarcode(artikel) {
    if (!artikel) return '';
    
    // Odstr√°ni v≈°etky pomlƒçky a medzery
    const cleanArtikel = artikel.replace(/[-\s]/g, '');
    
    // Ak m√° viac ako 9 znakov, prid√° pomlƒçku po 9. znaku
    if (cleanArtikel.length > 9) {
        return cleanArtikel.substring(0, 9) + '-' + cleanArtikel.substring(9);
    }
    
    // Ak m√° 9 alebo menej znakov, vr√°ti bez pomlƒçky
    return cleanArtikel;
}

/**
 * Generuje unik√°tne ID.
 * @returns {string} Unik√°tne ID.
 */
function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

/**
 * Debounce funkcia pre obmedzenie volania funkcie (napr. pri p√≠san√≠ do vyhƒæad√°vania).
 * @param {function} func - Funkcia, ktor√° sa m√° vykona≈•.
 * @param {number} delay - Oneskorenie v milisekund√°ch.
 * @returns {function} Debounced funkcia.
 */
function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}

/**
 * Zobraz√≠ toast notifik√°ciu.
 * @param {string} message - Spr√°va, ktor√° sa m√° zobrazi≈•.
 * @param {string} type - Typ notifik√°cie ('success', 'error', 'warning').
 */
function showToast(message, type = 'info') {
    elements.toast.textContent = message;
    elements.toast.className = `toast show ${type}`;
    setTimeout(() => {
        elements.toast.className = 'toast';
    }, 3000); // Skry≈• po 3 sekund√°ch
}

/**
 * Zobraz√≠/skryje spinner (naƒç√≠tavanie).
 * @param {HTMLElement} element - Element, do ktor√©ho sa m√° spinner prida≈•/odstr√°ni≈•.
 * @param {boolean} show - True pre zobrazenie, false pre skrytie.
 */
function showLoading(element, show) {
    if (show) {
        const spinner = document.createElement('div');
        spinner.className = 'spinner';
        element.innerHTML = ''; // Vyma≈æe existuj√∫ci obsah
        element.appendChild(spinner);
    } else {
        // Obnov√≠ p√¥vodn√Ω obsah alebo ho vyma≈æe
        element.innerHTML = '';
    }
}

// --- Naƒç√≠tanie datab√°zy z pou≈æ√≠vateƒæsk√©ho s√∫boru a zo servera ---

/**
 * Automaticky naƒç√≠ta datab√°zu z Excel s√∫boru 'data.xlsm' zo servera.
 * Vol√° sa pri ≈°tarte aplik√°cie, ak je datab√°za pr√°zdna.
 */
async function loadDatabaseFromServer() {
    try {
        console.log('Pok√∫≈°am sa naƒç√≠ta≈• data.xlsm zo servera...');
        
        // Stiahnutie s√∫boru zo servera pomocou fetch
        const response = await fetch('data.xlsm');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Konverzia na ArrayBuffer pre spracovanie cez XLSX
        const arrayBuffer = await response.arrayBuffer();
        
        // Spracovanie Excel s√∫boru pomocou SheetJS
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        // Prv√Ω riadok je hlaviƒçka, preskoƒç√≠me ho
        const dataRows = rawData.slice(1);
        
        // Vynulovanie datab√°zy pred naƒç√≠tan√≠m nov√Ωch d√°t
        database = [];
        let loadedCount = 0;
        
        // Spracovanie jednotliv√Ωch riadkov
        dataRows.forEach((row, index) => {
            // Podporujeme r√¥zne varianty n√°zvov stƒ∫pcov (veƒæk√© aj mal√© p√≠smen√°)
            const artikel = (row[0] || '').toString().trim();
            const nazov = (row[1] || '').toString().trim();
            const polica = (row[2] || '').toString().trim();
            
            // Pridanie len platn√Ωch z√°znamov (v≈°etky polia musia by≈• vyplnen√©)
            if (artikel && nazov && polica) {
                database.push({
                    id: uuidv4(),
                    artikel: artikel,
                    nazov: nazov,
                    polica: polica,
                    addedDate: new Date().toISOString().slice(0, 10)
                });
                loadedCount++;
            }
        });
        
        console.log(`Datab√°za automaticky naƒç√≠tan√° zo servera: ${loadedCount} polo≈æiek`);
        
        // Aktualiz√°cia UI po √∫spe≈°nom naƒç√≠tan√≠
        renderDatabaseList();
        updateStats();
        
        // Ulo≈æenie do localStorage
        saveDataToLocalStorage();
        
        // Zobrazenie √∫spe≈°nej notifik√°cie
        showToast(`Datab√°za automaticky naƒç√≠tan√°: ${loadedCount} polo≈æiek zo servera`, 'success');
        
    } catch (error) {
        console.error('Chyba pri automatickom naƒç√≠tan√≠ datab√°zy zo servera:', error);
        
        // Zobrazenie chybovej notifik√°cie
        let errorMessage = 'Chyba pri naƒç√≠tan√≠ datab√°zy zo servera.';
        if (error.message.includes('404')) {
            errorMessage += ' S√∫bor data.xlsm nebol n√°jden√Ω.';
        } else if (error.message.includes('network')) {
            errorMessage += ' Probl√©m s pripojen√≠m k serveru.';
        }
        
        showToast(errorMessage, 'error');
    }
}

/**
 * Naƒç√≠ta datab√°zu z Excel s√∫boru data.xlsm nahran√©ho pou≈æ√≠vateƒæom.
 * @param {File} file - Excel s√∫bor nahrat√Ω pou≈æ√≠vateƒæom
 */
async function loadDatabaseFromUserFile(file) {
    try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        // Prv√Ω riadok je hlaviƒçka, preskoƒç√≠me ho
        const dataRows = rawData.slice(1);
        
        database = [];
        dataRows.forEach((row, index) => {
            const artikel = (row[0] || '').toString().trim();
            const nazov = (row[1] || '').toString().trim();
            const polica = (row[2] || '').toString().trim();
            
            if (artikel && nazov && polica) {
                database.push({
                    id: uuidv4(),
                    artikel: artikel,
                    nazov: nazov,
                    polica: polica,
                    addedDate: new Date().toISOString().slice(0, 10)
                });
            }
        });
        
        console.log(`Datab√°za naƒç√≠tan√° z pou≈æ√≠vateƒæsk√©ho s√∫boru: ${database.length} polo≈æiek`);
        
        // Aktualizova≈• UI
        renderDatabaseList();
        updateStats();
        renderLabelsToPrint();
        
        showToast(`Datab√°za naƒç√≠tan√°: ${database.length} polo≈æiek z s√∫boru ${file.name}`, 'success');
        
    } catch (error) {
        console.error('Chyba pri naƒç√≠tan√≠ Excel s√∫boru:', error);
        showToast('Chyba pri naƒç√≠tan√≠ s√∫boru. Skontrolujte form√°t s√∫boru.', 'error');
    }
}

// --- Lok√°lne √∫lo≈æisko (pre nastavenia a doƒçasn√© zmeny) ---

/**
 * Ulo≈æ√≠ nastavenia, doƒçasn√© zmeny datab√°zy a ≈°t√≠tky do lok√°lneho √∫lo≈æiska.
 * Pou≈æ√≠va sa pre nastavenia V≈ΩDY a pre doƒçasn√© zmeny datab√°zy (po refreshi sa naƒç√≠ta z Excel).
 */
function saveDataToLocalStorage() {
    try {
        // Ulo≈æi≈• doƒçasn√© zmeny datab√°zy (bud√∫ prep√≠san√© po refreshi)
        localStorage.setItem('schaffleLabelDatabase', JSON.stringify(database));
        localStorage.setItem('schaffleLabelsToPrint', JSON.stringify(labels));
        localStorage.setItem('schafflePrintHistory', JSON.stringify(printHistory));
        localStorage.setItem('schafflePrintSets', JSON.stringify(printSets));
        localStorage.setItem('schaffleLabelIdCounter', labelIdCounter);
        localStorage.setItem('schaffleSettings', JSON.stringify({
            theme: currentTheme,
            language: currentLanguage,
            showLogo: showLogo,
            defaultTemplate: currentTemplate
        }));
    } catch (e) {
        console.error("Chyba pri ukladan√≠ d√°t do lok√°lneho √∫lo≈æiska:", e);
        showToast(translations[currentLanguage]['local-storage-limit-warning'], 'warning');
    }
}

/**
 * Naƒç√≠ta nastavenia a doƒçasn√© d√°ta z lok√°lneho √∫lo≈æiska.
 * Pou≈æ√≠va sa pre nastavenia V≈ΩDY. Datab√°za sa mus√≠ naƒç√≠ta≈• cez s√∫bor.
 */
function loadDataFromLocalStorage() {
    try {
        // Datab√°za sa u≈æ nenaƒç√≠tava z localStorage - mus√≠ sa naƒç√≠ta≈• cez s√∫bor
        database = [];

        const savedLabels = localStorage.getItem('schaffleLabelsToPrint');
        if (savedLabels) {
            labels = JSON.parse(savedLabels);
        } else {
            labels = [];
        }

        const savedPrintHistory = localStorage.getItem('schafflePrintHistory');
        if (savedPrintHistory) {
            printHistory = JSON.parse(savedPrintHistory);
        } else {
            printHistory = [];
        }

        const savedPrintSets = localStorage.getItem('schafflePrintSets');
        if (savedPrintSets) {
            printSets = JSON.parse(savedPrintSets);
        } else {
            printSets = {};
        }

        const savedIdCounter = localStorage.getItem('schaffleLabelIdCounter');
        if (savedIdCounter) {
            labelIdCounter = parseInt(savedIdCounter, 10);
        } else {
            labelIdCounter = 1;
        }

        // Nastavenia sa naƒç√≠tavaj√∫ v≈ædy
        const savedSettings = localStorage.getItem('schaffleSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            currentTheme = settings.theme || 'light';
            currentLanguage = settings.language || 'sk';
            showLogo = typeof settings.showLogo === 'boolean' ? settings.showLogo : false; // Predvolene skry≈• logo
            currentTemplate = settings.defaultTemplate || 'default';
        } else {
            // Predvolen√© nastavenia, ak niƒç nie je ulo≈æen√©
            currentTheme = 'light';
            currentLanguage = 'sk';
            showLogo = false; // Predvolene skry≈• logo
            currentTemplate = 'default';
        }
    } catch (e) {
        console.error("Chyba pri naƒç√≠tan√≠ d√°t z lok√°lneho √∫lo≈æiska:", e);
        showToast(translations[currentLanguage]['toast-error-import'], 'error');
        // Ak nastane chyba, resetujeme d√°ta
        database = [];
        labels = [];
        printHistory = [];
        printSets = {};
        labelIdCounter = 1;
        currentTheme = 'light';
        currentLanguage = 'sk';
        showLogo = false; // Predvolene skry≈• logo
        currentTemplate = 'default';
    }
}

// --- Internationaliz√°cia (i18n) ---

/**
 * Aplikuje zvolen√Ω jazyk na v≈°etky elementy s atrib√∫tom data-lang.
 * @param {string} lang - K√≥d jazyka ('sk', 'en', 'de').
 */
function applyLanguage(lang) {
    currentLanguage = lang;
    document.querySelectorAll('[data-lang]').forEach(element => {
        const key = element.getAttribute('data-lang');
        if (translations[lang] && translations[lang][key]) {
            element.textContent = translations[lang][key];
        }
    });
    document.querySelectorAll('[data-lang-placeholder]').forEach(element => {
        const key = element.getAttribute('data-lang-placeholder');
        if (translations[lang] && translations[lang][key]) {
            element.placeholder = translations[lang][key];
        }
    });
    // Aktualizova≈• n√°hƒæad ≈°t√≠tka
    updatePreview();
    // Prekresli≈• datab√°zu
    renderDatabaseList();
    // Aktualizova≈• ≈°tatistiky
    updateStats();
}

// --- Spr√°va t√©m ---

/**
 * Aplikuje zvolen√∫ t√©mu na str√°nku.
 * @param {string} theme - N√°zov t√©my ('light', 'dark', 'auto').
 */
function applyTheme(theme) {
    currentTheme = theme;
    const root = document.documentElement;
    if (theme === 'auto') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        elements.themeIcon.textContent = prefersDark ? '‚òÄÔ∏è' : 'üåô';
    } else {
        root.setAttribute('data-theme', theme);
        elements.themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
    // Nastavi≈• hodnotu v nastaveniach
    elements.themeSelect.value = theme;
}

// --- Spr√°va tabov ---

/**
 * Prep√≠na medzi tabmi.
 * @param {string} tabId - ID tabu, ktor√Ω sa m√° zobrazi≈•.
 */
function switchTab(tabId) {
    elements.tabContents.forEach(content => content.classList.remove('active'));
    elements.tabButtons.forEach(button => button.classList.remove('active'));

    document.getElementById(`${tabId}-tab`).classList.add('active');
    document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');

    // ≈†peci√°lne akcie pre konkr√©tne taby
    if (tabId === 'database') {
        renderDatabaseList(); // Prekresli≈• datab√°zu pri prepnut√≠
    } else if (tabId === 'labels') {
        updatePreview(); // Aktualizova≈• n√°hƒæad ≈°t√≠tka
    }
}

// --- Funkcie pre tab "≈†t√≠tky" ---

/**
 * Filtruje datab√°zu na z√°klade vyhƒæad√°vacieho dopytu a akt√≠vneho filtra.
 * Podporuje prefixov√© vyhƒæad√°vanie: polica:A1, nazov:"text", artikel:123456789
 * @returns {Array} Pole filtrovan√Ωch v√Ωsledkov.
 */
function filterDatabase() {
    const query = elements.searchInput.value.trim();
    const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;

    if (!query) {
        elements.searchResults.classList.add('hidden');
        return [];
    }

    // Spracovanie prefixov√©ho vyhƒæad√°vania
    const prefixRegex = /^(polica|nazov|artikel):\s*"?([^"]+)"?$/i;
    const match = query.match(prefixRegex);

    if (match) {
        const [, prefix, searchTerm] = match;
        const lowerSearchTerm = searchTerm.toLowerCase();
        
        return database.filter(item => {
            switch (prefix.toLowerCase()) {
                case 'polica':
                    return item.polica.toLowerCase().includes(lowerSearchTerm);
                case 'nazov':
                    return item.nazov.toLowerCase().includes(lowerSearchTerm);
                case 'artikel':
                    return item.artikel.toLowerCase().includes(lowerSearchTerm);
                default:
                    return false;
            }
        });
    }

    // Klasick√© vyhƒæad√°vanie bez prefixov
    const lowerQuery = query.toLowerCase();
    
    const filtered = database.filter(item => {
        switch (activeFilter) {
            case 'all':
                return item.artikel.toLowerCase().includes(lowerQuery) ||
                       item.nazov.toLowerCase().includes(lowerQuery) ||
                       item.polica.toLowerCase().includes(lowerQuery);
            case 'location':
                return item.polica.toLowerCase().includes(lowerQuery);
            default:
                return false;
        }
    });
    return filtered;
}

/**
 * Vykresl√≠ v√Ωsledky vyhƒæad√°vania.
 */
function renderSearchResults() {
    const filteredResults = filterDatabase();
    elements.resultsList.innerHTML = '';

    if (filteredResults.length === 0) {
        elements.resultsList.innerHTML = `<div class="no-results">${translations[currentLanguage]['no-results']}</div>`;
        elements.searchResults.classList.remove('hidden');
        return;
    }

    filteredResults.forEach(item => {
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `
            <div class="result-artikel">${item.artikel}</div>
            <div class="result-nazov">${item.nazov}</div>
            <div class="result-poznamka">${item.polica}</div>
        `;
        div.dataset.id = item.id;
        div.addEventListener('click', () => {
            // Predvyplni≈• r√Ωchly ≈°t√≠tok a prida≈• na tlaƒç
            elements.quickArtikel.value = item.artikel;
            elements.quickNazov.value = item.nazov;
            elements.quickPolica.value = item.polica;
            addLabelToPrintList({ ...item, quantity: 1 }, div); // Pridaj 1 ks s anim√°ciou
            elements.searchInput.value = ''; // Vyƒçisti vyhƒæad√°vanie
            elements.searchResults.classList.add('hidden'); // Skry v√Ωsledky
            updateQuickLabelButtons();
            updatePreview(); // Aktualizova≈• n√°hƒæad
            showToast(translations[currentLanguage]['toast-success-add-label'], 'success');
        });
        elements.resultsList.appendChild(div);
    });
    elements.searchResults.classList.remove('hidden');
}

/**
 * Aktualizuje stav tlaƒçidiel "Prida≈• na tlaƒç".
 */
function updateQuickLabelButtons() {
    const artikel = elements.quickArtikel.value.trim();
    const nazov = elements.quickNazov.value.trim();
    // Polica u≈æ nie je povinn√° podƒæa po≈æiadavky

    const isValid = artikel && nazov && validateArtikel(artikel); // Pridan√° valid√°cia artikla
    elements.addQuickBtn.disabled = !isValid;
}

/**
 * Prid√° ≈°t√≠tok do zoznamu na tlaƒç.
 * @param {object} item - Objekt ≈°t√≠tka (artikel, nazov, polica, quantity).
 */
/**
 * Vytvor√≠ anim√°ciu presunu ≈°t√≠tka pri pridan√≠ do zoznamu na tlaƒç.
 * @param {HTMLElement} sourceElement - Element, z ktor√©ho sa ≈°t√≠tok pres√∫va.
 */
function animateLabelAddition(sourceElement) {
    if (!sourceElement) return;
    
    // Vytvorenie doƒçasn√©ho animaƒçn√©ho elementu
    const animElement = document.createElement('div');
    animElement.className = 'label-animation';
    animElement.innerHTML = 'üìã ≈†t√≠tok pridan√Ω!';
    
    // Z√≠skanie poz√≠cie zdrojov√©ho elementu
    const sourceRect = sourceElement.getBoundingClientRect();
    const targetElement = document.getElementById('labelsList');
    const targetRect = targetElement.getBoundingClientRect();
    
    // Nastavenie poƒçiatoƒçnej poz√≠cie
    animElement.style.position = 'fixed';
    animElement.style.left = sourceRect.left + 'px';
    animElement.style.top = sourceRect.top + 'px';
    animElement.style.zIndex = '10000';
    animElement.style.background = 'var(--success-color)';
    animElement.style.color = 'white';
    animElement.style.padding = '8px 12px';
    animElement.style.borderRadius = '4px';
    animElement.style.fontSize = '14px';
    animElement.style.fontWeight = 'bold';
    animElement.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
    animElement.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    animElement.style.opacity = '1';
    animElement.style.transform = 'scale(1)';
    
    document.body.appendChild(animElement);
    
    // Spustenie anim√°cie
    setTimeout(() => {
        animElement.style.left = targetRect.left + 'px';
        animElement.style.top = targetRect.top + 'px';
        animElement.style.transform = 'scale(0.8)';
        animElement.style.opacity = '0.8';
    }, 50);
    
    // Odstr√°nenie elementu po anim√°cii
    setTimeout(() => {
        if (animElement.parentNode) {
            animElement.parentNode.removeChild(animElement);
        }
    }, 650);
}

/**
 * Prid√° ≈°t√≠tok do zoznamu na tlaƒç.
 * @param {Object} item - ≈†t√≠tok na pridanie.
 * @param {HTMLElement} sourceElement - Element pre anim√°ciu (voliteƒæn√Ω).
 */
function addLabelToPrintList(item, sourceElement = null) {
    const existingLabelIndex = labels.findIndex(l => l.artikel === item.artikel && l.nazov === item.nazov && l.polica === item.polica);

    if (existingLabelIndex > -1) {
        labels[existingLabelIndex].quantity += item.quantity;
    } else {
        labels.push({
            id: uuidv4(), // Unik√°tne ID pre ≈°t√≠tok v zozname na tlaƒç
            artikel: item.artikel,
            nazov: item.nazov,
            polica: item.polica,
            quantity: item.quantity || 1
        });
    }
    
    // Spustenie anim√°cie
    if (sourceElement) {
        animateLabelAddition(sourceElement);
    }
    
    renderLabelsToPrint();
    saveDataToLocalStorage(); // Ulo≈æi≈• zmeny ≈°t√≠tkov
}

/**
 * Vykresl√≠ zoznam ≈°t√≠tkov pripraven√Ωch na tlaƒç.
 */
function renderLabelsToPrint() {
    elements.labelsList.innerHTML = '';
    if (labels.length === 0) {
        elements.emptyState.classList.remove('hidden');
        elements.labelsList.classList.add('hidden');
        elements.previewBtn.classList.add('hidden');
        elements.printBtn.classList.add('hidden');
        if (elements.printSetsSection) {
            elements.printSetsSection.style.display = 'none';
        }
        if (elements.bulkActionsSection) {
            elements.bulkActionsSection.style.display = 'none';
        }
        // Odstr√°nen√©: elements.exportPdfBtn.classList.add('hidden');
    } else {
        elements.emptyState.classList.add('hidden');
        elements.labelsList.classList.remove('hidden');
        elements.previewBtn.classList.remove('hidden');
        elements.printBtn.classList.remove('hidden');
        if (elements.printSetsSection) {
            elements.printSetsSection.style.display = 'block';
        }
        if (elements.bulkActionsSection) {
            elements.bulkActionsSection.style.display = 'block';
        }
        // Odstr√°nen√©: elements.exportPdfBtn.classList.remove('hidden');

        labels.forEach(label => {
            const div = document.createElement('div');
            div.className = 'label-item';
            div.dataset.id = label.id; // Pou≈æ√≠vame unik√°tne ID pre SortableJS
            div.innerHTML = `
                <div class="label-content">
                    <div class="label-checkbox">
                        <input type="checkbox" class="label-checkbox-input" data-label-id="${label.id}">
                    </div>
                    <div class="label-info">
                        <div class="label-artikel">${label.artikel}</div>
                        <div class="label-nazov">${label.nazov}</div>
                        <div class="label-poznamka">
                            <span class="database-polica">${label.polica}</span>
                        </div>
                    </div>
                    <div class="label-controls">
                        <span class="quantity-label" data-lang="quantity-label">Mno≈æstvo:</span>
                        <input type="number" class="quantity-input" value="${label.quantity}" min="1" data-id="${label.id}">
                        <button class="btn btn-danger btn-small remove-label-btn" data-id="${label.id}">
                            ‚úñÔ∏è
                        </button>
                    </div>
                </div>
            `;
            elements.labelsList.appendChild(div);
        });

        // Pridanie event listenerov pre checkboxy
        elements.labelsList.querySelectorAll('.label-checkbox-input').forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkSelection);
        });

        // Pridanie event listenerov pre zmenu mno≈æstva a odstr√°nenie
        elements.labelsList.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', (e) => {
                const id = e.target.dataset.id;
                const newQuantity = parseInt(e.target.value, 10);
                const labelIndex = labels.findIndex(l => l.id === id);
                if (labelIndex > -1 && newQuantity >= 1) {
                    labels[labelIndex].quantity = newQuantity;
                    saveDataToLocalStorage(); // Ulo≈æi≈• zmeny ≈°t√≠tkov
                } else if (newQuantity < 1) {
                    // Ak je mno≈æstvo menej ako 1, odstr√°ni≈• ≈°t√≠tok
                    removeLabelFromPrintList(id);
                }
            });
        });

        elements.labelsList.querySelectorAll('.remove-label-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                removeLabelFromPrintList(id);
            });
        });

        // Inicializ√°cia SortableJS
        new Sortable(elements.labelsList, {
            animation: 150,
            onEnd: function (evt) {
                const movedItem = labels.splice(evt.oldIndex, 1)[0];
                labels.splice(evt.newIndex, 0, movedItem);
                saveDataToLocalStorage(); // Ulo≈æi≈• zmeny ≈°t√≠tkov
                renderLabelsToPrint(); // Prekresli≈• pre spr√°vne zobrazenie
            }
        });
    }
    updateLabelsCount();
    updatePrintButtons();
}

/**
 * Odstr√°ni ≈°t√≠tok zo zoznamu na tlaƒç.
 * @param {string} id - ID ≈°t√≠tka.
 */
function removeLabelFromPrintList(id) {
    labels = labels.filter(label => label.id !== id);
    renderLabelsToPrint();
    saveDataToLocalStorage(); // Ulo≈æi≈• zmeny ≈°t√≠tkov
}

/**
 * Aktualizuje poƒçet ≈°t√≠tkov na tlaƒç.
 */
function updateLabelsCount() {
    const totalLabels = labels.reduce((sum, label) => sum + label.quantity, 0);
    elements.labelsCount.textContent = `${totalLabels} ${translations[currentLanguage]['labels-count-suffix']}`;
}

/**
 * Aktualizuje viditeƒænos≈• tlaƒçidiel "N√°hƒæad tlaƒçe" a "Tlaƒçi≈•".
 */
function updatePrintButtons() {
    if (labels.length > 0) {
        elements.previewBtn.classList.remove('hidden');
        elements.printBtn.classList.remove('hidden');
        // Odstr√°nen√©: elements.exportPdfBtn.classList.remove('hidden');
    } else {
        elements.previewBtn.classList.add('hidden');
        elements.printBtn.classList.add('hidden');
        // Odstr√°nen√©: elements.exportPdfBtn.classList.add('hidden');
    }
}

/**
 * Aktualizuje n√°hƒæad ≈°t√≠tka na z√°klade vstupov alebo vybran√©ho ≈°t√≠tka.
 */
function updatePreview() {
    const artikel = elements.quickArtikel.value || '123456789';
    const nazov = elements.quickNazov.value || translations[currentLanguage]['preview-nazov-placeholder'] || 'Uk√°≈ækov√Ω produkt s dlh≈°√≠m n√°zvom';
    const polica = elements.quickPolica.value || 'A1-B2-C3';

    // Form√°tovanie artiklu s pomlƒçkami
    const formattedArtikel = formatArtikel(artikel);
    elements.previewArtikel.textContent = formattedArtikel;
    elements.previewNazov.textContent = nazov;
    elements.previewPolica.textContent = polica;

    // Logo je v≈ædy skryt√© podƒæa po≈æiadavky
    // Odstr√°nen√©: elements.previewLogo.style.display = showLogo ? 'block' : 'none';

    // Aplikova≈• ≈°abl√≥nu
    const template = elements.templateSelect.value || currentTemplate;
    applyTemplateToPreview(template);

    // Generovanie ƒçiarov√©ho k√≥du (pou≈æije form√°tovan√Ω artikel pre ƒçiarov√Ω k√≥d)
    try {
        const barcodeArtikel = formatArtikelForBarcode(artikel);
        JsBarcode("#previewBarcode", barcodeArtikel, {
            format: "CODE128",
            displayValue: false,
            height: 20, // Presn√° v√Ω≈°ka podƒæa ≈°pecifik√°cie
            width: 1,
            margin: 0
        });
    } catch (e) {
        console.error("Chyba pri generovan√≠ n√°hƒæadu ƒçiarov√©ho k√≥du:", e);
        // M√¥≈æe sa sta≈•, ak je artikel pr√°zdny alebo neplatn√Ω
        elements.previewBarcode.innerHTML = '<text x="0" y="20" font-size="8" fill="red">Neplatn√Ω artikel</text>';
    }
}

/**
 * Aplikuje ≈°abl√≥nu na n√°hƒæad ≈°t√≠tka.
 * @param {string} template - N√°zov ≈°abl√≥ny ('default', 'compact', 'detailed').
 */
function applyTemplateToPreview(template) {
    const previewLabel = document.querySelector('.preview-label');
    previewLabel.className = 'preview-label'; // Reset classes
    previewLabel.classList.add(`template-${template}`);
}

/**
 * Validuje osobn√© ƒç√≠slo pre menovky.
 * @param {string} personalNumber - Osobn√© ƒç√≠slo na valid√°ciu.
 * @returns {boolean} True ak je osobn√© ƒç√≠slo platn√©, false ak nie.
 */
function validatePersonalNumber(personalNumber) {
    if (!personalNumber) return false;
    
    // Odstr√°ni v≈°etky medzery a pomlƒçky
    const cleanNumber = personalNumber.replace(/[-\s]/g, '');
    
    // Kontrola, ƒçi obsahuje len ƒç√≠sla
    if (!/^\d+$/.test(cleanNumber)) {
        return false;
    }
    
    // Kontrola dƒ∫≈æky: aspo≈à 6 ƒç√≠slic, maxim√°lne 15
    return cleanNumber.length >= 6 && cleanNumber.length <= 15;
}

/**
 * Aktualizuje n√°hƒæad menovky na z√°klade vstupov.
 */
function updateNameTagPreview() {
    const meno = elements.nameTagMeno ? elements.nameTagMeno.value || 'J√°n' : 'J√°n';
    const priezvisko = elements.nameTagPriezvisko ? elements.nameTagPriezvisko.value || 'Nov√°k' : 'Nov√°k';
    const osobneCislo = elements.nameTagOsobneCislo ? elements.nameTagOsobneCislo.value || '1234567890' : '1234567890';
    const oddelenie = elements.nameTagOddelenie ? elements.nameTagOddelenie.value || 'IT Podpora' : 'IT Podpora';

    if (elements.nameTagPreviewPersonalNumber) {
        elements.nameTagPreviewPersonalNumber.textContent = osobneCislo;
    }
    if (elements.nameTagPreviewFullName) {
        elements.nameTagPreviewFullName.textContent = `${meno} ${priezvisko}`;
    }
    if (elements.nameTagPreviewDepartment) {
        elements.nameTagPreviewDepartment.textContent = oddelenie;
    }

    // Generovanie ƒçiarov√©ho k√≥du z osobn√©ho ƒç√≠sla
    if (elements.nameTagPreviewBarcode) {
        try {
            JsBarcode("#nameTagPreviewBarcode", osobneCislo, {
                format: "CODE128",
                displayValue: false,
                height: 20,
                width: 1,
                margin: 0
            });
        } catch (e) {
            console.error("Chyba pri generovan√≠ n√°hƒæadu ƒçiarov√©ho k√≥du menovky:", e);
            elements.nameTagPreviewBarcode.innerHTML = '<text x="0" y="20" font-size="8" fill="red">Neplatn√© osobn√© ƒç√≠slo</text>';
        }
    }
}

/**
 * Aktualizuje n√°hƒæad ≈°t√≠tka police na z√°klade vstupov.
 */
function updateShelfPreview() {
    const fach = elements.shelfFach ? elements.shelfFach.value || '0501' : '0501';
    const polica = elements.shelfPolica ? elements.shelfPolica.value || '00-00-00' : '00-00-00';

    if (elements.shelfPreviewFach) {
        elements.shelfPreviewFach.textContent = fach;
    }
    if (elements.shelfPreviewShelfDesc) {
        elements.shelfPreviewShelfDesc.textContent = 'Polica ≈°t√≠tok';
    }
    if (elements.shelfPreviewShelfLocation) {
        elements.shelfPreviewShelfLocation.textContent = `${fach}\t${polica}`;
    }

    // Generovanie ƒçiarov√©ho k√≥du vo form√°te "FACH[TAB]POLICA"
    if (elements.shelfPreviewBarcode) {
        try {
            const barcodeData = `${fach}\t${polica}`;
            JsBarcode("#shelfPreviewBarcode", barcodeData, {
                format: "CODE128",
                displayValue: false,
                height: 20,
                width: 1,
                margin: 0
            });
        } catch (e) {
            console.error("Chyba pri generovan√≠ n√°hƒæadu ƒçiarov√©ho k√≥du police:", e);
            elements.shelfPreviewBarcode.innerHTML = '<text x="0" y="20" font-size="8" fill="red">Neplatn√© √∫daje</text>';
        }
    }
}

/**
 * Aktualizuje stav tlaƒçidiel pre menovky.
 */
function updateNameTagButtons() {
    const meno = elements.nameTagMeno ? elements.nameTagMeno.value.trim() : '';
    const priezvisko = elements.nameTagPriezvisko ? elements.nameTagPriezvisko.value.trim() : '';
    const osobneCislo = elements.nameTagOsobneCislo ? elements.nameTagOsobneCislo.value.trim() : '';

    const isValid = meno && priezvisko && osobneCislo && validatePersonalNumber(osobneCislo);
    if (elements.addNameTagBtn) {
        elements.addNameTagBtn.disabled = !isValid;
    }
}

/**
 * Aktualizuje stav tlaƒçidiel pre police.
 */
function updateShelfButtons() {
    const fach = elements.shelfFach ? elements.shelfFach.value.trim() : '';
    const polica = elements.shelfPolica ? elements.shelfPolica.value.trim() : '';

    const isValid = fach && polica;
    if (elements.addShelfLabelBtn) {
        elements.addShelfLabelBtn.disabled = !isValid;
    }
}

/**
 * Zobraz√≠ modal s n√°hƒæadom tlaƒçe.
 */
function showPrintPreviewModal() {
    if (labels.length === 0) {
        showToast(translations[currentLanguage]['toast-warning-no-labels'], 'warning');
        return;
    }

    elements.printPreviewContainer.innerHTML = ''; // Vyƒçisti≈• predch√°dzaj√∫ci n√°hƒæad

    labels.forEach(label => {
        for (let i = 0; i < label.quantity; i++) {
            const printLabelDiv = document.createElement('div');
            
            // Determine template class based on label type
            let templateClass = `template-${currentTemplate}`;
            if (label.type === 'nametag') {
                templateClass = 'template-nametag';
            } else if (label.type === 'shelf') {
                templateClass = 'template-shelf';
            }
            
            printLabelDiv.className = `preview-label-item ${templateClass}`;
            
            // Generate different content based on label type
            if (label.type === 'nametag') {
                printLabelDiv.innerHTML = `
                    <div class="preview-content">
                        <!-- Prv√Ω riadok: ƒåiarov√Ω k√≥d -->
                        <div class="preview-barcode-row">
                            <svg id="barcode-${label.id}-${i}"></svg>
                        </div>
                        <!-- Druh√Ω riadok: Osobn√© ƒç√≠slo -->
                        <div class="preview-personal-number">${label.osobneCislo}</div>
                        <!-- Tret√≠ riadok: Cel√© meno -->
                        <div class="preview-full-name">${label.meno} ${label.priezvisko}</div>
                        <!-- ≈†tvrt√Ω riadok: Horizont√°lna ƒçiara -->
                        <div class="preview-line"></div>
                        <!-- Piaty riadok: Oddelenie -->
                        <div class="preview-department">${label.oddelenie || ''}</div>
                    </div>
                `;
            } else if (label.type === 'shelf') {
                printLabelDiv.innerHTML = `
                    <div class="preview-content">
                        <!-- Prv√Ω riadok: ƒåiarov√Ω k√≥d -->
                        <div class="preview-barcode-row">
                            <svg id="barcode-${label.id}-${i}"></svg>
                        </div>
                        <!-- Druh√Ω riadok: Fach -->
                        <div class="preview-fach">${label.fach}</div>
                        <!-- Tret√≠ riadok: Popis -->
                        <div class="preview-shelf-desc">Polica ≈°t√≠tok</div>
                        <!-- ≈†tvrt√Ω riadok: Horizont√°lna ƒçiara -->
                        <div class="preview-line"></div>
                        <!-- Piaty riadok: Umiestnenie -->
                        <div class="preview-shelf-location">${label.fach}	${label.policaLocation}</div>
                    </div>
                `;
            } else {
                // Regular label (default behavior)
                printLabelDiv.innerHTML = `
                    <div class="preview-content">
                        <!-- Prv√Ω riadok: ƒåiarov√Ω k√≥d -->
                        <div class="preview-barcode-row">
                            <svg id="barcode-${label.id}-${i}"></svg>
                        </div>
                        <!-- Druh√Ω riadok: Artikel -->
                        <div class="preview-artikel">${formatArtikel(label.artikel)}</div>
                        <!-- Tret√≠ riadok: N√°zov produktu -->
                        <div class="preview-nazov">${label.nazov}</div>
                        <!-- ≈†tvrt√Ω riadok: Horizont√°lna ƒçiara -->
                        <div class="preview-line"></div>
                        <!-- Piaty riadok: Polica -->
                        <div class="preview-polica">${label.polica}</div>
                    </div>
                `;
            }
            
            elements.printPreviewContainer.appendChild(printLabelDiv);

            // Generovanie ƒçiarov√©ho k√≥du pre ka≈æd√Ω ≈°t√≠tok v n√°hƒæade modalu
            try {
                let barcodeData;
                if (label.type === 'nametag') {
                    barcodeData = label.osobneCislo;
                } else if (label.type === 'shelf') {
                    barcodeData = `${label.fach}\t${label.policaLocation}`;
                } else {
                    barcodeData = formatArtikelForBarcode(label.artikel);
                }
                
                JsBarcode(`#barcode-${label.id}-${i}`, barcodeData, {
                    format: "CODE128",
                    displayValue: false,
                    height: 24, // Presn√° v√Ω≈°ka podƒæa ≈°pecifik√°cie
                    width: 1,
                    margin: 0
                });
            } catch (e) {
                console.error("Chyba pri generovan√≠ ƒçiarov√©ho k√≥du v modale:", e);
                document.getElementById(`barcode-${label.id}-${i}`).innerHTML = '<text x="0" y="20" font-size="8" fill="red">Neplatn√Ω k√≥d</text>';
            }
        }
    });

    elements.printPreviewModal.style.display = 'block';
}

/**
 * Exportuje ≈°t√≠tky ako vektorov√Ω PDF s√∫bor pomocou jsPDF a svg2pdf.js.
 * Funkcia vytvor√≠ SVG elementy pre ka≈æd√Ω ≈°t√≠tok a konvertuje ich do PDF form√°tu.
 * Zabezpeƒçuje vysok√∫ kvalitu tlaƒçe vhodn√∫ pre firemn√© pou≈æitie.
 */
async function exportLabelSVGtoPDF() {
    if (labels.length === 0) {
        showToast(translations[currentLanguage]['toast-warning-no-labels'], 'warning');
        return;
    }

    try {
        // Kontrola dostupnosti jsPDF kni≈ænice
        if (!window.jspdf || !window.jspdf.jsPDF) {
            showToast('PDF export nie je k dispoz√≠cii kv√¥li ch√Ωbaj√∫cim kni≈æniciam. Pou≈æite tlaƒçidlo "Tlaƒçi≈•" pre tlaƒç ≈°t√≠tkov.', 'warning');
            return;
        }

        // Inicializ√°cia jsPDF - vytvorenie nov√©ho PDF dokumentu
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'in', // palce pre presn√© rozlo≈æenie ≈°t√≠tkov
            format: 'letter' // ≈°tandardn√Ω form√°t papiera
        });

        // Rozmer ≈°t√≠tka v palcoch (2" x 1" podƒæa ≈°pecifik√°cie)
        const labelWidthInches = 2;
        const labelHeightInches = 1;
        
        // Medzery medzi ≈°t√≠tkami pre lep≈°ie usporiadanie
        const marginX = 0.25;
        const marginY = 0.25;
        
        // V√Ωpoƒçet poƒçtu ≈°t√≠tkov na str√°nku
        const pageWidth = 8.5; // ≈°√≠rka Letter form√°tu
        const pageHeight = 11; // v√Ω≈°ka Letter form√°tu
        const labelsPerRow = Math.floor((pageWidth - marginX) / (labelWidthInches + marginX));
        const labelsPerColumn = Math.floor((pageHeight - marginY) / (labelHeightInches + marginY));
        const labelsPerPage = labelsPerRow * labelsPerColumn;

        let currentLabelCount = 0;
        let currentPageLabelCount = 0;

        // Zobrazenie progress notifik√°cie
        showToast(`Generujem PDF... ${labels.length} ≈°t√≠tkov`, 'info');

        // Iter√°cia cez v≈°etky ≈°t√≠tky v zozname
        for (const label of labels) {
            // Pre ka≈æd√© mno≈æstvo dan√©ho ≈°t√≠tka
            for (let i = 0; i < label.quantity; i++) {
                // Ak je potrebn√° nov√° str√°nka
                if (currentPageLabelCount >= labelsPerPage) {
                    pdf.addPage();
                    currentPageLabelCount = 0;
                }

                // V√Ωpoƒçet poz√≠cie ≈°t√≠tka na str√°nke
                const row = Math.floor(currentPageLabelCount / labelsPerRow);
                const col = currentPageLabelCount % labelsPerRow;
                const x = marginX + col * (labelWidthInches + marginX);
                const y = marginY + row * (labelHeightInches + marginY);

                // Vytvorenie SVG elementa pre ≈°t√≠tok
                const svgElement = await createLabelSVG(label, labelWidthInches, labelHeightInches);
                
                // Konverzia SVG do PDF pomocou svg2pdf.js
                if (pdf.svg && typeof pdf.svg === 'function') {
                    await pdf.svg(svgElement, {
                        x: x,
                        y: y,
                        width: labelWidthInches,
                        height: labelHeightInches
                    });
                } else {
                    // Fallback ak svg2pdf nie je dostupn√© - pou≈æije sa text
                    const formattedArtikel = formatArtikel(label.artikel);
                    pdf.setFontSize(14);
                    pdf.text(formattedArtikel, x + labelWidthInches/2, y + 0.3, { align: 'center' });
                    pdf.setFontSize(8);
                    pdf.text(label.nazov.substring(0, 30), x + labelWidthInches/2, y + 0.5, { align: 'center' });
                    pdf.setFontSize(8);
                    pdf.text(label.polica, x + labelWidthInches/2, y + 0.8, { align: 'center' });
                    
                    // Pridanie ohraniƒçenia ≈°t√≠tka
                    pdf.rect(x, y, labelWidthInches, labelHeightInches);
                }

                currentLabelCount++;
                currentPageLabelCount++;
            }
        }

        // Generovanie n√°zvu s√∫boru s aktu√°lnym d√°tumom
        const currentDate = new Date().toISOString().slice(0, 10);
        const filename = `schaeffler_labels_${currentDate}.pdf`;
        
        // Ulo≈æenie PDF s√∫boru
        pdf.save(filename);
        
        // Zobrazenie √∫spe≈°nej notifik√°cie
        showToast(`PDF exportovan√© √∫spe≈°ne: ${currentLabelCount} ≈°t√≠tkov v s√∫bore ${filename}`, 'success');

    } catch (error) {
        console.error('Chyba pri exporte PDF:', error);
        showToast('Nastala chyba pri exporte PDF. Pou≈æite tlaƒçidlo "Tlaƒçi≈•" pre tlaƒç ≈°t√≠tkov.', 'error');
    }
}

/**
 * Vytvor√≠ SVG element pre jednotliv√Ω ≈°t√≠tok s presnou ≈°pecifik√°ciou rozlo≈æenia.
 * @param {Object} label - Objekt ≈°t√≠tka obsahuj√∫ci artikel, n√°zov a policu
 * @param {number} width - ≈†√≠rka ≈°t√≠tka v palcoch
 * @param {number} height - V√Ω≈°ka ≈°t√≠tka v palcoch
 * @returns {SVGElement} SVG element reprezentuj√∫ci ≈°t√≠tok
 */
async function createLabelSVG(label, width, height) {
    // Konverzia palcov na pixely (96 DPI ≈°tandard)
    const widthPx = width * 96;
    const heightPx = height * 96;
    
    // Z√≠skanie hodn√¥t CSS premenn√Ωch pre veƒækosti p√≠sma
    const rootStyles = getComputedStyle(document.documentElement);
    const artikelFontSize = parseInt(rootStyles.getPropertyValue('--label-artikel-font-size'));
    const nazovFontSize = parseInt(rootStyles.getPropertyValue('--label-nazov-font-size'));
    const policaFontSize = parseInt(rootStyles.getPropertyValue('--label-polica-font-size'));
    const barcodeHeight = parseInt(rootStyles.getPropertyValue('--label-barcode-height'));
    
    // Vytvorenie SVG kontajnera
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', widthPx);
    svg.setAttribute('height', heightPx);
    svg.setAttribute('viewBox', `0 0 ${widthPx} ${heightPx}`);
    svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    
    // Pridanie bieleho pozadia s ƒçiernym okrajom
    const background = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    background.setAttribute('x', '0');
    background.setAttribute('y', '0');
    background.setAttribute('width', widthPx);
    background.setAttribute('height', heightPx);
    background.setAttribute('fill', 'white');
    background.setAttribute('stroke', 'black');
    background.setAttribute('stroke-width', '1');
    svg.appendChild(background);

    // Logo firmy je odstr√°nen√© podƒæa po≈æiadavky

    // Rozlo≈æenie obsahu ≈°t√≠tka - 5 riadkov podƒæa ≈°pecifik√°cie
    let currentY = 8; // Poƒçiatoƒçn√° poz√≠cia Y
    
    // 1. RIADOK: ƒåiarov√Ω k√≥d (v√Ω≈°ka z CSS premennej)
    const barcodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    
    try {
        // Vytvorenie doƒçasn√©ho Canvas elementu pre generovanie ƒçiarov√©ho k√≥du
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = widthPx - 16; // ≈†√≠rka s padding
        tempCanvas.height = barcodeHeight;
        
        // Generovanie ƒçiarov√©ho k√≥du pomocou JsBarcode
        JsBarcode(tempCanvas, formatArtikelForBarcode(label.artikel), {
            format: "CODE128",
            displayValue: false,
            height: barcodeHeight,
            width: 1,
            margin: 0,
            background: 'transparent'
        });
        
        // Konverzia Canvas na Data URL a vlo≈æenie do SVG
        const dataURL = tempCanvas.toDataURL('image/png');
        const barcodeImage = document.createElementNS('http://www.w3.org/2000/svg', 'image');
        barcodeImage.setAttribute('x', '8');
        barcodeImage.setAttribute('y', currentY);
        barcodeImage.setAttribute('width', widthPx - 16);
        barcodeImage.setAttribute('height', barcodeHeight);
        barcodeImage.setAttribute('href', dataURL);
        barcodeGroup.appendChild(barcodeImage);
        
    } catch (error) {
        console.warn('Chyba pri generovan√≠ ƒçiarov√©ho k√≥du, pou≈æije sa z√°lo≈æn√Ω text:', error);
        // Z√°lo≈æn√Ω text ak zlyh√° generovanie ƒçiarov√©ho k√≥du
        const fallbackText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        fallbackText.setAttribute('x', widthPx / 2);
        fallbackText.setAttribute('y', currentY + barcodeHeight / 2);
        fallbackText.setAttribute('text-anchor', 'middle');
        fallbackText.setAttribute('fill', 'black');
        fallbackText.setAttribute('font-family', 'Arial, sans-serif');
        fallbackText.setAttribute('font-size', '8');
        fallbackText.textContent = formatArtikelForBarcode(label.artikel);
        barcodeGroup.appendChild(fallbackText);
    }
    
    svg.appendChild(barcodeGroup);
    currentY += barcodeHeight + 2;

    // 2. RIADOK: Artikel vo form√°te xxx-xxx-xxx (veƒækos≈• z CSS premennej)
    const artikelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    artikelText.setAttribute('x', widthPx / 2);
    artikelText.setAttribute('y', currentY);
    artikelText.setAttribute('text-anchor', 'middle');
    artikelText.setAttribute('fill', 'black');
    artikelText.setAttribute('font-family', 'Arial, sans-serif');
    artikelText.setAttribute('font-size', artikelFontSize); // ƒΩahko upraviteƒæn√° veƒækos≈• cez CSS/SVG
    artikelText.textContent = formatArtikel(label.artikel);
    svg.appendChild(artikelText);
    currentY += 16;

    // 3. RIADOK: N√°zov produktu (veƒækos≈• z CSS premennej)
    const nazovText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    nazovText.setAttribute('x', widthPx / 2);
    nazovText.setAttribute('y', currentY);
    nazovText.setAttribute('text-anchor', 'middle');
    nazovText.setAttribute('fill', 'black');
    nazovText.setAttribute('font-family', 'Arial, sans-serif');
    nazovText.setAttribute('font-size', nazovFontSize); // ƒΩahko upraviteƒæn√° veƒækos≈• cez CSS/SVG
    
    // Skr√°tenie textu ak je pr√≠li≈° dlh√Ω
    let nazovTextContent = label.nazov;
    if (nazovTextContent.length > 50) {
        nazovTextContent = nazovTextContent.substring(0, 47) + '...';
    }
    nazovText.textContent = nazovTextContent;
    svg.appendChild(nazovText);
    currentY += 12;

    // 4. RIADOK: Horizont√°lna ƒçiara
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', '8');
    line.setAttribute('y1', currentY);
    line.setAttribute('x2', widthPx - 8);
    line.setAttribute('y2', currentY);
    line.setAttribute('stroke', 'black');
    line.setAttribute('stroke-width', '1');
    svg.appendChild(line);
    currentY += 4;

    // 5. RIADOK: Polica - tuƒçn√©, kurz√≠va (veƒækos≈• z CSS premennej)
    const policaText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    policaText.setAttribute('x', widthPx / 2);
    policaText.setAttribute('y', currentY);
    policaText.setAttribute('text-anchor', 'middle');
    policaText.setAttribute('fill', 'black');
    policaText.setAttribute('font-family', 'Arial, sans-serif');
    policaText.setAttribute('font-size', policaFontSize); // ƒΩahko upraviteƒæn√° veƒækos≈• cez CSS/SVG
    policaText.setAttribute('font-weight', 'bold'); // Tuƒçn√©
    policaText.setAttribute('font-style', 'italic'); // Kurz√≠va
    policaText.textContent = label.polica;
    svg.appendChild(policaText);

    return svg;
}


/**
 * Aktualizuje poƒçet oznaƒçen√Ωch ≈°t√≠tkov a stav hromadn√Ωch akci√≠.
 */
function updateBulkSelection() {
    if (!elements.selectedCount || !elements.bulkDeleteBtn || !elements.bulkQuantityBtn) return;
    
    const checkboxes = document.querySelectorAll('.label-checkbox-input');
    const selectedCheckboxes = document.querySelectorAll('.label-checkbox-input:checked');
    const selectedCount = selectedCheckboxes.length;
    
    // Aktualizova≈• poƒçet oznaƒçen√Ωch
    elements.selectedCount.textContent = `${selectedCount} ${translations[currentLanguage]['bulk-selected-count']}`;
    
    // Aktivova≈•/deaktivova≈• tlaƒçidl√°
    const hasSelection = selectedCount > 0;
    elements.bulkDeleteBtn.disabled = !hasSelection;
    elements.bulkQuantityBtn.disabled = !hasSelection;
    
    // Aktualizova≈• stav "oznaƒçi≈• v≈°etky"
    if (elements.selectAllLabels) {
        elements.selectAllLabels.checked = selectedCount === checkboxes.length && selectedCount > 0;
        elements.selectAllLabels.indeterminate = selectedCount > 0 && selectedCount < checkboxes.length;
    }
}

/**
 * Oznaƒç√≠/odznaƒç√≠ v≈°etky ≈°t√≠tky.
 * @param {boolean} checked - ƒåi maj√∫ by≈• ≈°t√≠tky oznaƒçen√©.
 */
function selectAllLabels(checked) {
    const checkboxes = document.querySelectorAll('.label-checkbox-input');
    checkboxes.forEach(checkbox => {
        checkbox.checked = checked;
    });
    updateBulkSelection();
}

/**
 * Zma≈æe oznaƒçen√© ≈°t√≠tky.
 */
function deleteBulkLabels() {
    const selectedCheckboxes = document.querySelectorAll('.label-checkbox-input:checked');
    if (selectedCheckboxes.length === 0) {
        showToast(translations[currentLanguage]['toast-error-no-selection'], 'error');
        return;
    }
    
    if (confirm(translations[currentLanguage]['confirm-bulk-delete'])) {
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.labelId);
        labels = labels.filter(label => !selectedIds.includes(label.id));
        
        renderLabelsToPrint();
        saveDataToLocalStorage();
        showToast(translations[currentLanguage]['toast-success-bulk-delete'], 'success');
    }
}

/**
 * Zmen√≠ mno≈æstvo oznaƒçen√Ωch ≈°t√≠tkov.
 */
function changeBulkQuantity() {
    const selectedCheckboxes = document.querySelectorAll('.label-checkbox-input:checked');
    if (selectedCheckboxes.length === 0) {
        showToast(translations[currentLanguage]['toast-error-no-selection'], 'error');
        return;
    }
    
    const newQuantity = prompt(translations[currentLanguage]['bulk-change-quantity'], '1');
    if (newQuantity === null) return; // Zru≈°en√© u≈æ√≠vateƒæom
    
    const quantity = parseInt(newQuantity, 10);
    if (isNaN(quantity) || quantity < 1) {
        showToast(translations[currentLanguage]['toast-error-invalid-quantity'], 'error');
        return;
    }
    
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.labelId);
    labels.forEach(label => {
        if (selectedIds.includes(label.id)) {
            label.quantity = quantity;
        }
    });
    
    renderLabelsToPrint();
    saveDataToLocalStorage();
    showToast(translations[currentLanguage]['toast-success-bulk-quantity'], 'success');
}

/**
 * Ulo≈æ√≠ aktu√°lny zoznam ≈°t√≠tkov ako tlaƒçov√∫ sadu.
 * @param {string} setName - N√°zov tlaƒçovej sady.
 */
function savePrintSet(setName) {
    if (!setName || !setName.trim()) {
        showToast(translations[currentLanguage]['toast-error-set-name'], 'error');
        return;
    }
    
    if (labels.length === 0) {
        showToast(translations[currentLanguage]['toast-error-no-labels-save'], 'error');
        return;
    }
    
    const trimmedName = setName.trim();
    printSets[trimmedName] = [...labels]; // K√≥pia aktu√°lnych ≈°t√≠tkov
    
    saveDataToLocalStorage();
    updatePrintSetsSelect();
    showToast(translations[currentLanguage]['toast-success-save-set'], 'success');
    
    // Vyƒçisti≈• input
    if (elements.printSetName) {
        elements.printSetName.value = '';
    }
}

/**
 * Naƒç√≠ta tlaƒçov√∫ sadu a nahrad√≠ aktu√°lny zoznam ≈°t√≠tkov.
 * @param {string} setName - N√°zov tlaƒçovej sady.
 */
function loadPrintSet(setName) {
    if (!setName || !printSets[setName]) {
        showToast(translations[currentLanguage]['toast-error-no-set-selected'], 'error');
        return;
    }
    
    labels = [...printSets[setName]]; // K√≥pia ulo≈æenej sady
    renderLabelsToPrint();
    saveDataToLocalStorage();
    showToast(translations[currentLanguage]['toast-success-load-set'], 'success');
}

/**
 * Zma≈æe tlaƒçov√∫ sadu.
 * @param {string} setName - N√°zov tlaƒçovej sady.
 */
function deletePrintSet(setName) {
    if (!setName || !printSets[setName]) {
        showToast(translations[currentLanguage]['toast-error-no-set-selected'], 'error');
        return;
    }
    
    if (confirm(translations[currentLanguage]['confirm-delete-set'])) {
        delete printSets[setName];
        saveDataToLocalStorage();
        updatePrintSetsSelect();
        showToast(translations[currentLanguage]['toast-success-delete-set'], 'success');
    }
}

/**
 * Aktualizuje v√Ωber tlaƒçov√Ωch s√°d v dropdown menu.
 */
function updatePrintSetsSelect() {
    if (!elements.printSetsSelect) return;
    
    elements.printSetsSelect.innerHTML = `<option value="">${translations[currentLanguage]['select-print-set']}</option>`;
    
    Object.keys(printSets).sort().forEach(setName => {
        const option = document.createElement('option');
        option.value = setName;
        option.textContent = `${setName} (${printSets[setName].length} ≈°t√≠tkov)`;
        elements.printSetsSelect.appendChild(option);
    });
}

/**
 * Prid√° z√°znam do hist√≥rie tlaƒçe.
 * @param {Array} labelsData - Pole ≈°t√≠tkov, ktor√© sa tlaƒçili.
 */
function addToPrintHistory(labelsData) {
    const historyEntry = {
        id: uuidv4(),
        timestamp: new Date().toISOString(),
        labels: labelsData.map(label => ({
            artikel: label.artikel,
            nazov: label.nazov,
            polica: label.polica,
            quantity: label.quantity
        })),
        totalLabels: labelsData.reduce((sum, label) => sum + label.quantity, 0)
    };
    
    printHistory.unshift(historyEntry); // Prida≈• na zaƒçiatok (najnov≈°ie prv√©)
    
    // Obmedzi≈• hist√≥riu na posledn√Ωch 1000 z√°znamov
    if (printHistory.length > 1000) {
        printHistory = printHistory.slice(0, 1000);
    }
    
    saveDataToLocalStorage();
    updatePrintHistoryDisplay();
}

/**
 * Vykresl√≠ zoznam hist√≥rie tlaƒçe.
 */
function updatePrintHistoryDisplay() {
    if (!elements.printHistoryList) return;
    
    const query = elements.historySearchInput ? elements.historySearchInput.value.toLowerCase().trim() : '';
    let filteredHistory = printHistory;
    
    if (query) {
        filteredHistory = printHistory.filter(entry => 
            entry.labels.some(label => 
                label.artikel.toLowerCase().includes(query) ||
                label.nazov.toLowerCase().includes(query) ||
                label.polica.toLowerCase().includes(query)
            )
        );
    }
    
    elements.printHistoryList.innerHTML = '';
    
    if (filteredHistory.length === 0) {
        elements.printHistoryList.innerHTML = `<div class="no-results">${translations[currentLanguage]['no-history']}</div>`;
        return;
    }
    
    filteredHistory.forEach(entry => {
        const date = new Date(entry.timestamp);
        const formattedDate = date.toLocaleDateString('sk-SK') + ' ' + date.toLocaleTimeString('sk-SK');
        
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
            <div class="history-header">
                <strong>${translations[currentLanguage]['history-printed-at']}: ${formattedDate}</strong>
                <span class="history-total">${entry.totalLabels} ${translations[currentLanguage]['history-labels-count']}</span>
            </div>
            <div class="history-labels">
                ${entry.labels.map(label => `
                    <div class="history-label-item">
                        <span class="history-artikel">${label.artikel}</span>
                        <span class="history-nazov">${label.nazov}</span>
                        <span class="history-polica database-polica">${label.polica}</span>
                        <span class="history-quantity">√ó${label.quantity}</span>
                    </div>
                `).join('')}
            </div>
        `;
        elements.printHistoryList.appendChild(div);
    });
    
    // Aktualizova≈• ≈°tatistiky
    updatePrintHistoryStats();
}

/**
 * Aktualizuje ≈°tatistiky hist√≥rie tlaƒçe.
 */
function updatePrintHistoryStats() {
    if (!elements.totalPrintedLabels || !elements.totalPrintSessions) return;
    
    const totalLabels = printHistory.reduce((sum, entry) => sum + entry.totalLabels, 0);
    const totalSessions = printHistory.length;
    
    elements.totalPrintedLabels.textContent = totalLabels;
    elements.totalPrintSessions.textContent = totalSessions;
}

/**
 * Vyma≈æe cel√∫ hist√≥riu tlaƒçe.
 */
function clearPrintHistory() {
    if (confirm(translations[currentLanguage]['confirm-clear-history'])) {
        printHistory = [];
        saveDataToLocalStorage();
        updatePrintHistoryDisplay();
        showToast('Hist√≥ria tlaƒçe bola vymazan√°.', 'success');
    }
}

/**
 * Exportuje hist√≥riu tlaƒçe do CSV.
 */
function exportPrintHistory() {
    if (printHistory.length === 0) {
        showToast('≈Ωiadna hist√≥ria na export!', 'warning');
        return;
    }
    
    const csvData = [];
    csvData.push(['D√°tum', 'ƒåas', 'Artikel', 'N√°zov', 'Polica', 'Mno≈æstvo']);
    
    printHistory.forEach(entry => {
        const date = new Date(entry.timestamp);
        const dateStr = date.toLocaleDateString('sk-SK');
        const timeStr = date.toLocaleTimeString('sk-SK');
        
        entry.labels.forEach(label => {
            csvData.push([
                dateStr,
                timeStr,
                label.artikel,
                label.nazov,
                label.polica,
                label.quantity
            ]);
        });
    });
    
    const csv = csvData.map(row => row.join(',')).join('\n');
    const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
    const filename = `historia_tlace_${new Date().toISOString().slice(0, 10)}.csv`;
    downloadBlob(blob, filename);
    
    showToast('Hist√≥ria tlaƒçe bola exportovan√°.', 'success');
}

/**
 * Priprav√≠ oblas≈• tlaƒçe a spust√≠ tlaƒç.
 */
function printLabels() {
    if (labels.length === 0) {
        showToast(translations[currentLanguage]['toast-warning-no-labels'], 'warning');
        return;
    }

    // Prida≈• do hist√≥rie pred tlaƒçou
    addToPrintHistory([...labels]);

    elements.printArea.innerHTML = ''; // Vyƒçisti≈• predch√°dzaj√∫ci obsah
    elements.printArea.classList.remove('hidden');

    labels.forEach(label => {
        for (let i = 0; i < label.quantity; i++) {
            const printLabelDiv = document.createElement('div');
            
            // Determine template class based on label type
            let templateClass = `template-${currentTemplate}`;
            if (label.type === 'nametag') {
                templateClass = 'template-nametag';
            } else if (label.type === 'shelf') {
                templateClass = 'template-shelf';
            }
            
            printLabelDiv.className = `print-label ${templateClass}`;
            
            // Generate different content based on label type
            if (label.type === 'nametag') {
                printLabelDiv.innerHTML = `
                    <div class="print-content">
                        <!-- Prv√Ω riadok: ƒåiarov√Ω k√≥d -->
                        <div class="print-barcode-row">
                            <svg id="printBarcode-${label.id}-${i}"></svg>
                        </div>
                        <!-- Druh√Ω riadok: Osobn√© ƒç√≠slo -->
                        <div class="print-personal-number">${label.osobneCislo}</div>
                        <!-- Tret√≠ riadok: Cel√© meno -->
                        <div class="print-full-name">${label.meno} ${label.priezvisko}</div>
                        <!-- ≈†tvrt√Ω riadok: Horizont√°lna ƒçiara -->
                        <div class="print-line"></div>
                        <!-- Piaty riadok: Oddelenie -->
                        <div class="print-department">${label.oddelenie || ''}</div>
                    </div>
                `;
            } else if (label.type === 'shelf') {
                printLabelDiv.innerHTML = `
                    <div class="print-content">
                        <!-- Prv√Ω riadok: ƒåiarov√Ω k√≥d -->
                        <div class="print-barcode-row">
                            <svg id="printBarcode-${label.id}-${i}"></svg>
                        </div>
                        <!-- Druh√Ω riadok: Fach -->
                        <div class="print-fach">${label.fach}</div>
                        <!-- Tret√≠ riadok: Popis -->
                        <div class="print-shelf-desc">Polica ≈°t√≠tok</div>
                        <!-- ≈†tvrt√Ω riadok: Horizont√°lna ƒçiara -->
                        <div class="print-line"></div>
                        <!-- Piaty riadok: Umiestnenie -->
                        <div class="print-shelf-location">${label.fach}	${label.policaLocation}</div>
                    </div>
                `;
            } else {
                // Regular label (default behavior)
                printLabelDiv.innerHTML = `
                    <div class="print-content">
                        <!-- Prv√Ω riadok: ƒåiarov√Ω k√≥d -->
                        <div class="print-barcode-row">
                            <svg id="printBarcode-${label.id}-${i}"></svg>
                        </div>
                        <!-- Druh√Ω riadok: Artikel -->
                        <div class="print-artikel">${formatArtikel(label.artikel)}</div>
                        <!-- Tret√≠ riadok: N√°zov produktu -->
                        <div class="print-nazov">${label.nazov}</div>
                        <!-- ≈†tvrt√Ω riadok: Horizont√°lna ƒçiara -->
                        <div class="print-line"></div>
                        <!-- Piaty riadok: Polica -->
                        <div class="print-polica">${label.polica}</div>
                    </div>
                `;
            }
            
            elements.printArea.appendChild(printLabelDiv);

            // Generovanie ƒçiarov√©ho k√≥du pre ka≈æd√Ω ≈°t√≠tok
            try {
                let barcodeData;
                if (label.type === 'nametag') {
                    barcodeData = label.osobneCislo;
                } else if (label.type === 'shelf') {
                    barcodeData = `${label.fach}\t${label.policaLocation}`;
                } else {
                    barcodeData = formatArtikelForBarcode(label.artikel);
                }
                
                JsBarcode(`#printBarcode-${label.id}-${i}`, barcodeData, {
                    format: "CODE128",
                    displayValue: false,
                    height: 36, // Presn√° v√Ω≈°ka podƒæa ≈°pecifik√°cie
                    width: 1,
                    margin: 0
                });
            } catch (e) {
                console.error("Chyba pri generovan√≠ ƒçiarov√©ho k√≥du pre tlaƒç:", e);
                document.getElementById(`printBarcode-${label.id}-${i}`).innerHTML = '<text x="0" y="20" font-size="8" fill="red">Neplatn√Ω k√≥d</text>';
            }
        }
    });

    // Skry≈• modal pred tlaƒçou
    elements.printPreviewModal.style.display = 'none';

    // Spusti≈• tlaƒç
    window.print();

    // Po tlaƒçi skry≈• oblas≈• tlaƒçe
    setTimeout(() => {
        elements.printArea.classList.add('hidden');
        elements.printArea.innerHTML = ''; // Vyƒçisti≈• oblas≈• tlaƒçe
    }, 500); // Kr√°tke oneskorenie pre dokonƒçenie tlaƒçe
}

/**
 * Aktualizuje ≈°tatistiky datab√°zy.
 */
function updateStats() {
    elements.totalCount.textContent = database.length;
}

// --- Datab√°zov√© oper√°cie (localStorage only) ---

/**
 * Prid√° alebo aktualizuje polo≈æku v datab√°ze (len v localStorage, doƒçasne).
 * @param {object} item - Objekt polo≈æky (artikel, nazov, polica, addedDate).
 */
async function addOrUpdateItem(item) {
    const existingIndex = database.findIndex(dbItem => dbItem.artikel === item.artikel);
    if (existingIndex === -1) {
        database.push({ ...item, id: uuidv4() });
        showToast(translations[currentLanguage]['toast-success-db-add'] + " (doƒçasne ulo≈æen√©)", 'success');
    } else {
        database[existingIndex] = { ...database[existingIndex], ...item };
        showToast(translations[currentLanguage]['toast-success-db-update'] + " (doƒçasne ulo≈æen√©)", 'success');
    }
    saveDataToLocalStorage();
    renderDatabaseList();
    updateStats();
}

/**
 * Odstr√°ni polo≈æku z datab√°zy (len z localStorage, doƒçasne).
 * @param {string} id - ID dokumentu na odstr√°nenie.
 */
async function deleteItem(id) {
    if (!window.confirm(translations[currentLanguage]['confirm-delete-item'])) return;

    database = database.filter(item => item.id !== id);
    saveDataToLocalStorage();
    renderDatabaseList();
    updateStats();
    showToast(translations[currentLanguage]['toast-success-db-delete'] + " (doƒçasne odstr√°nen√©)", 'success');
}

/**
 * Vyma≈æe cel√∫ datab√°zu (len z localStorage, doƒçasne).
 */
async function clearAllDatabase() {
    if (!window.confirm(translations[currentLanguage]['confirm-clear-db'])) return;

    database = [];
    labels = [];
    saveDataToLocalStorage();
    renderDatabaseList();
    renderLabelsToPrint();
    updateStats();
    showToast(translations[currentLanguage]['toast-success-clear-db'] + " (doƒçasne vymazan√©)", 'success');
}

/**
 * Spracuje import s√∫borov a hromadne ich ulo≈æ√≠ do datab√°zy.
 * @param {Array} itemsToProcess - Pole objektov na import.
 */
async function processAndSaveItems(itemsToProcess) {
    if (itemsToProcess.length === 0) return;

    let updatedCount = 0;
    itemsToProcess.forEach(newItem => {
        const existingIndex = database.findIndex(item => item.artikel === newItem.artikel);
        if (existingIndex > -1) {
            database[existingIndex] = { ...database[existingIndex], ...newItem };
        } else {
            database.push({ ...newItem, id: uuidv4() });
        }
        updatedCount++;
    });
    
    if (updatedCount > 0) {
        saveDataToLocalStorage();
        renderDatabaseList();
        updateStats();
    }
    showToast(translations[currentLanguage]['large-import-success'].replace('{count}', updatedCount) + " (doƒçasne ulo≈æen√©)", 'success');
}


/**
 * Spracuje import s√∫borov (CSV, Excel, JSON). ≈†pecificky data.xlsm pre datab√°zu.
 * @param {FileList} files - Zoznam s√∫borov na import.
 */
async function handleFileImport(files) {
    if (files.length === 0) return;
    showLoading(elements.databaseList, true);

    const today = new Date().toISOString().slice(0, 10);
    let errorsEncountered = false;
    let skippedRowCount = 0;
    
    let itemsToProcess = [];
    let isDataXlsmFile = false;

    for (const file of files) {
        const fileExtension = file.name.split('.').pop().toLowerCase();
        const fileName = file.name.toLowerCase();
        
        // Skontrolova≈•, ƒçi je to data.xlsm s√∫bor
        if (fileName === 'data.xlsm') {
            isDataXlsmFile = true;
            await loadDatabaseFromUserFile(file);
            showLoading(elements.databaseList, false);
            renderDatabaseList();
            elements.fileImport.value = '';
            elements.importFileBtn.disabled = true;
            return;
        }
        
        try {
            let rawData = [];
            if (fileExtension === 'csv') {
                const text = await file.text();
                const result = PapaParse.parse(text, { header: true, skipEmptyLines: true });
                rawData = result.data;
            } else if (fileExtension === 'xls' || fileExtension === 'xlsx' || fileExtension === 'xlsm') {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
            } else if (fileExtension === 'json') {
                const text = await file.text();
                rawData = JSON.parse(text);
            } else {
                showToast(`${translations[currentLanguage]['toast-error-import']} (${file.name} - ${translations[currentLanguage]['unsupported-format']})`, 'error');
                errorsEncountered = true;
                continue;
            }

            for (const row of rawData) {
                const artikel = (row.Artikel || row.artikel || row.ARTIKEL || '').toString().trim();
                const nazov = (row.Nazov || row.nazov || row.NAZOV || '').toString().trim();
                const polica = (row.Polica || row.polica || row.POLICA || '').toString().trim();

                if (artikel && nazov && polica) {
                    itemsToProcess.push({ artikel, nazov, polica, addedDate: today });
                } else {
                    skippedRowCount++;
                }
            }

        } catch (e) {
            console.error(`Chyba pri spracovan√≠ s√∫boru ${file.name}:`, e);
            showToast(`${translations[currentLanguage]['toast-error-import']} (${file.name})`, 'error');
            errorsEncountered = true;
        }
    }

    await processAndSaveItems(itemsToProcess);

    showLoading(elements.databaseList, false);
    renderDatabaseList();

    if (itemsToProcess.length > 0) {
        let toastMessage = translations[currentLanguage]['large-import-success'].replace('{count}', itemsToProcess.length);
        if (skippedRowCount > 0) {
            toastMessage += ` ${translations[currentLanguage]['import-skipped-rows'].replace('{count}', skippedRowCount)}`;
        }
        showToast(toastMessage, skippedRowCount > 0 || errorsEncountered ? 'warning' : 'success');
    } else if (skippedRowCount > 0) {
         showToast(translations[currentLanguage]['import-all-skipped'].replace('{count}', skippedRowCount), 'error');
    }

    elements.fileImport.value = '';
    elements.importFileBtn.disabled = true;
}



/**
 * Prid√° jednu polo≈æku do datab√°zy alebo ju aktualizuje.
 */
async function addSingleToDatabase() {
    const artikel = elements.newArtikel.value.trim();
    const nazov = elements.newNazov.value.trim();
    const polica = elements.newPolica.value.trim();

    if (!artikel || !nazov || !polica) {
        showToast(translations[currentLanguage]['toast-error-db-add'], 'warning');
        return;
    }

    const today = new Date().toISOString().slice(0, 10);
    const newItem = { artikel, nazov, polica, addedDate: today };

    const editingId = elements.addDatabaseBtn.dataset.editingId;
    if (editingId) { // Edit√°cia
        const index = database.findIndex(item => item.id === editingId);
        if (index > -1) {
            database[index].nazov = newItem.nazov;
            database[index].polica = newItem.polica;
            saveDataToLocalStorage();
            renderDatabaseList();
            showToast(translations[currentLanguage]['toast-success-db-update'] + " (doƒçasne ulo≈æen√©)", 'success');
        }
    } else { // Pridanie novej polo≈æky
        await addOrUpdateItem(newItem);
    }

    // Reset formul√°ra
    delete elements.addDatabaseBtn.dataset.editingId;
    elements.addDatabaseBtn.innerHTML = `‚ûï <span data-lang="btn-add-db">${translations[currentLanguage]['btn-add-db']}</span>`;
    elements.newArtikel.value = '';
    elements.newNazov.value = '';
    elements.newPolica.value = '';
    elements.newArtikel.disabled = false;
}

/**
 * Vykresl√≠ zoznam polo≈æiek v datab√°ze.
 */
function renderDatabaseList() {
    const query = elements.dbSearchInput.value.toLowerCase().trim();
    elements.databaseList.innerHTML = '';

    const filteredDb = database.filter(item => {
        return item.artikel.toLowerCase().includes(query) ||
               item.nazov.toLowerCase().includes(query) ||
               item.polica.toLowerCase().includes(query);
    });

    if (database.length === 0) {
        elements.databaseList.innerHTML = `<div class="no-results">üìÅ ${translations[currentLanguage]['database-not-loaded']}</div>`;
        return;
    }

    if (filteredDb.length === 0) {
        elements.databaseList.innerHTML = `<div class="no-results">${translations[currentLanguage]['no-results']}</div>`;
        return;
    }

    filteredDb.forEach(item => {
        const div = document.createElement('div');
        div.className = 'database-item';
        div.innerHTML = `
            <div class="database-info">
                <div class="database-artikel">${item.artikel}</div>
                <div class="database-nazov">${item.nazov}</div>
                <div class="database-poznamka">
                    <span class="database-polica">${item.polica}</span>
                </div>
            </div>
            <div class="database-actions">
                <button class="btn btn-secondary btn-small edit-db-item" data-id="${item.id}">
                    ‚úèÔ∏è
                </button>
                <button class="btn btn-danger btn-small delete-db-item" data-id="${item.id}">
                    üóëÔ∏è
                </button>
            </div>
        `;
        div.querySelector('.edit-db-item').addEventListener('click', (e) => {
            editDatabaseItem(e.currentTarget.dataset.id);
        });
        div.querySelector('.delete-db-item').addEventListener('click', (e) => {
            deleteItem(e.currentTarget.dataset.id);
        });
        elements.databaseList.appendChild(div);
    });
}

/**
 * Edituje polo≈æku v datab√°ze.
 * @param {string} id - ID polo≈æky na edit√°ciu.
 */
function editDatabaseItem(id) {
    const item = database.find(item => item.id === id);
    if (!item) return;

    elements.newArtikel.value = item.artikel;
    elements.newNazov.value = item.nazov;
    elements.newPolica.value = item.polica;

    elements.newArtikel.disabled = true; // Zak√°za≈• zmenu artiklu
    elements.addDatabaseBtn.innerHTML = `üíæ <span data-lang="btn-save-db">${translations[currentLanguage]['btn-save-db']}</span>`;
    elements.addDatabaseBtn.dataset.editingId = item.id;
}

// --- Funkcie pre tab "Nastavenia" ---

/**
 * Ulo≈æ√≠ nastavenia z formul√°ra.
 */
function saveSettings() {
    currentTheme = elements.themeSelect.value;
    currentLanguage = elements.languageSettingSelect.value;
    showLogo = elements.logoSelect.value === 'show';
    currentTemplate = elements.defaultTemplateSelect.value;

    applyTheme(currentTheme);
    applyLanguage(currentLanguage);
    updatePreview();
    saveDataToLocalStorage(); // Ulo≈æi≈• nastavenia do lok√°lneho √∫lo≈æiska
    showToast(translations[currentLanguage]['toast-success-settings'], 'success');
}

// --- Inicializ√°cia a Event Listenery ---

document.addEventListener('DOMContentLoaded', async () => {
    // Naƒç√≠ta≈• nastavenia z lok√°lneho √∫lo≈æiska (s√∫ to pou≈æ√≠vateƒæsk√© preferencie)
    loadDataFromLocalStorage(); 

    // Aplikova≈• naƒç√≠tan√© nastavenia
    applyTheme(currentTheme);
    applyLanguage(currentLanguage);
    elements.themeSelect.value = currentTheme;
    elements.languageSelect.value = currentLanguage;
    elements.languageSettingSelect.value = currentLanguage;
    elements.logoSelect.value = showLogo ? 'show' : 'hide';
    elements.defaultTemplateSelect.value = currentTemplate;
    elements.templateSelect.value = currentTemplate;

    // Automatick√© naƒç√≠tanie datab√°zy zo servera, ak je datab√°za pr√°zdna
    if (database.length === 0) {
        await loadDatabaseFromServer();
    }

    // Poƒçiatoƒçn√© vykreslenie UI 
    switchTab('labels');
    renderLabelsToPrint(); 
    updatePreview();
    updateStats();
    renderDatabaseList();
    updatePrintHistoryDisplay(); // Pridan√° aktualiz√°cia hist√≥rie tlaƒçe
    updatePrintSetsSelect(); // Pridan√° aktualiz√°cia tlaƒçov√Ωch s√°d
    updateBulkSelection(); // Pridan√° aktualiz√°cia hromadn√Ωch akci√≠
    
    // Event Listenery pre taby
    elements.tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            switchTab(button.dataset.tab);
        });
    });

    // Event Listener pre prep√≠nanie t√©my
    elements.themeToggle.addEventListener('click', () => {
        const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        applyTheme(newTheme);
        saveDataToLocalStorage();
    });

    // Event Listener pre v√Ωber jazyka v hlaviƒçke
    elements.languageSelect.addEventListener('change', (e) => {
        applyLanguage(e.target.value);
        elements.languageSettingSelect.value = e.target.value; // Synchronizova≈• nastavenie
        saveDataToLocalStorage();
    });

    // --- ≈†t√≠tky (Labels) tab Event Listenery ---

    // Vyhƒæad√°vanie
    elements.searchInput.addEventListener('input', debounce(renderSearchResults, 300));
    elements.filterButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            elements.filterButtons.forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            renderSearchResults();
        });
    });

    // R√Ωchly ≈°t√≠tok
    [elements.quickArtikel, elements.quickNazov, elements.quickPolica].forEach(input => {
        input.addEventListener('input', updateQuickLabelButtons);
        input.addEventListener('input', updatePreview);
    });

    // Klik na "Artikel" v n√°hƒæade ≈°t√≠tka sa fokusuje input "Artikel" v r√Ωchlom formul√°ri
    elements.previewArtikel.addEventListener('click', () => {
        elements.quickArtikel.focus();
        elements.quickArtikel.select(); // Oznaƒç√≠ obsah pre ƒæahk√∫ edit√°ciu
    });

    // Prida≈• cursor: pointer pre artikel v n√°hƒæade
    elements.previewArtikel.style.cursor = 'pointer';
    elements.previewArtikel.title = 'Kliknite pre edit√°ciu artikla';

    elements.addQuickBtn.addEventListener('click', () => {
        const artikel = elements.quickArtikel.value.trim();
        const nazov = elements.quickNazov.value.trim();
        const polica = elements.quickPolica.value.trim() || ''; // Pr√°zdna polica je povolen√°
        
        // Valid√°cia artikla
        if (!validateArtikel(artikel)) {
            showToast(translations[currentLanguage]['toast-error-invalid-artikel'], 'error');
            elements.quickArtikel.focus();
            return;
        }
        
        const newItem = {
            artikel: artikel,
            nazov: nazov,
            polica: polica,
            quantity: 1
        };
        addLabelToPrintList(newItem, elements.addQuickBtn);
        showToast(translations[currentLanguage]['toast-success-add-label'], 'success');
    });

    // N√°hƒæad ≈°t√≠tka
    elements.templateSelect.addEventListener('change', (e) => {
        currentTemplate = e.target.value;
        updatePreview();
    });

    // Tlaƒç ≈°t√≠tkov
    elements.previewBtn.addEventListener('click', showPrintPreviewModal);
    elements.printBtn.addEventListener('click', printLabels);

    // Tlaƒçov√© sady (Print Sets)
    if (elements.savePrintSetBtn) {
        elements.savePrintSetBtn.addEventListener('click', () => {
            const setName = elements.printSetName.value.trim();
            savePrintSet(setName);
        });
    }
    if (elements.loadPrintSetBtn) {
        elements.loadPrintSetBtn.addEventListener('click', () => {
            const setName = elements.printSetsSelect.value;
            loadPrintSet(setName);
        });
    }
    if (elements.deletePrintSetBtn) {
        elements.deletePrintSetBtn.addEventListener('click', () => {
            const setName = elements.printSetsSelect.value;
            deletePrintSet(setName);
        });
    }

    // Hromadn√© akcie (Bulk Actions)
    if (elements.selectAllLabels) {
        elements.selectAllLabels.addEventListener('change', (e) => {
            selectAllLabels(e.target.checked);
        });
    }
    if (elements.bulkDeleteBtn) {
        elements.bulkDeleteBtn.addEventListener('click', deleteBulkLabels);
    }
    if (elements.bulkQuantityBtn) {
        elements.bulkQuantityBtn.addEventListener('click', changeBulkQuantity);
    }
    // Odstr√°nen√©: elements.exportPdfBtn.addEventListener('click', exportLabelSVGtoPDF);
    elements.closePrintPreview.addEventListener('click', () => {
        elements.printPreviewModal.style.display = 'none';
    });
    window.addEventListener('click', (event) => {
        if (event.target === elements.printPreviewModal) {
            elements.printPreviewModal.style.display = 'none';
        }
    });

    // --- Datab√°za (Database) tab Event Listenery ---

    // R√Ωchle akcie
    elements.clearDbBtn.addEventListener('click', clearAllDatabase);
    elements.exportCsvBtn.addEventListener('click', () => exportDatabase('csv'));
    elements.exportExcelBtn.addEventListener('click', () => exportDatabase('excel'));
    elements.exportJsonBtn.addEventListener('click', () => exportDatabase('json'));

    // Import s√∫borov (Drag & Drop)
    elements.dropZone.addEventListener('click', () => elements.fileImport.click());
    elements.dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        elements.dropZone.classList.add('drag-over');
    });
    elements.dropZone.addEventListener('dragleave', () => {
        elements.dropZone.classList.remove('drag-over');
    });
    elements.dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        elements.dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) {
            handleFileImport(e.dataTransfer.files);
        }
    });
    elements.fileImport.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileImport(e.target.files);
        }
    });
    elements.importFileBtn.addEventListener('click', () => {
        elements.fileImport.click();
    });


    // Prida≈• jednotlivo
    elements.addDatabaseBtn.addEventListener('click', addSingleToDatabase);

    // Filtrovanie datab√°zy
    elements.dbSearchInput.addEventListener('input', debounce(renderDatabaseList, 300));

    // --- Hist√≥ria tlaƒçe (Print History) tab Event Listenery ---
    if (elements.historySearchInput) {
        elements.historySearchInput.addEventListener('input', debounce(updatePrintHistoryDisplay, 300));
    }
    if (elements.clearHistoryBtn) {
        elements.clearHistoryBtn.addEventListener('click', clearPrintHistory);
    }
    if (elements.exportHistoryBtn) {
        elements.exportHistoryBtn.addEventListener('click', exportPrintHistory);
    }

    // --- Name Tag tab Event Listenery ---
    if (elements.nameTagMeno) {
        elements.nameTagMeno.addEventListener('input', updateNameTagButtons);
        elements.nameTagMeno.addEventListener('input', updateNameTagPreview);
    }
    if (elements.nameTagPriezvisko) {
        elements.nameTagPriezvisko.addEventListener('input', updateNameTagButtons);
        elements.nameTagPriezvisko.addEventListener('input', updateNameTagPreview);
    }
    if (elements.nameTagOsobneCislo) {
        elements.nameTagOsobneCislo.addEventListener('input', updateNameTagButtons);
        elements.nameTagOsobneCislo.addEventListener('input', updateNameTagPreview);
    }
    if (elements.nameTagOddelenie) {
        elements.nameTagOddelenie.addEventListener('input', updateNameTagPreview);
    }
    if (elements.addNameTagBtn) {
        elements.addNameTagBtn.addEventListener('click', () => {
            const meno = elements.nameTagMeno.value.trim();
            const priezvisko = elements.nameTagPriezvisko.value.trim();
            const osobneCislo = elements.nameTagOsobneCislo.value.trim();
            const oddelenie = elements.nameTagOddelenie.value.trim() || '';
            
            if (!validatePersonalNumber(osobneCislo)) {
                showToast('Neplatn√© osobn√© ƒç√≠slo! Mus√≠ obsahova≈• 6-15 ƒç√≠slic.', 'error');
                elements.nameTagOsobneCislo.focus();
                return;
            }
            
            const nameTagItem = {
                artikel: osobneCislo, // Use personal number as artikel for internal processing
                nazov: `${meno} ${priezvisko}`,
                polica: oddelenie,
                quantity: 1,
                type: 'nametag', // Mark as name tag type
                meno: meno,
                priezvisko: priezvisko,
                osobneCislo: osobneCislo,
                oddelenie: oddelenie
            };
            addLabelToPrintList(nameTagItem, elements.addNameTagBtn);
            showToast('Menovka bola √∫spe≈°ne pridan√° na tlaƒç!', 'success');
        });
    }

    // --- Shelf Label tab Event Listenery ---
    if (elements.shelfFach) {
        elements.shelfFach.addEventListener('input', updateShelfButtons);
        elements.shelfFach.addEventListener('input', updateShelfPreview);
    }
    if (elements.shelfPolica) {
        elements.shelfPolica.addEventListener('input', updateShelfButtons);
        elements.shelfPolica.addEventListener('input', updateShelfPreview);
    }
    if (elements.addShelfLabelBtn) {
        elements.addShelfLabelBtn.addEventListener('click', () => {
            const fach = elements.shelfFach.value.trim();
            const polica = elements.shelfPolica.value.trim();
            
            const shelfItem = {
                artikel: fach, // Use fach as artikel for internal processing
                nazov: 'Polica ≈°t√≠tok',
                polica: `${fach}\t${polica}`, // Store combined data
                quantity: 1,
                type: 'shelf', // Mark as shelf type
                fach: fach,
                policaLocation: polica
            };
            addLabelToPrintList(shelfItem, elements.addShelfLabelBtn);
            showToast('≈†t√≠tok police bol √∫spe≈°ne pridan√Ω na tlaƒç!', 'success');
        });
    }

    // Initialize name tag and shelf previews
    updateNameTagPreview();
    updateShelfPreview();
    updateNameTagButtons();
    updateShelfButtons();

    // --- Nastavenia (Settings) tab Event Listenery ---
    elements.saveSettingsBtn.addEventListener('click', saveSettings);
});

// Nastavi≈• predvolen√Ω text pre placeholder prekladu, ak nie je definovan√Ω
if (!translations.sk['preview-nazov-placeholder']) {
    translations.sk['preview-nazov-placeholder'] = 'Uk√°≈ækov√Ω produkt s dlh≈°√≠m n√°zvom';
}
if (!translations.en['preview-nazov-placeholder']) {
    translations.en['preview-nazov-placeholder'] = 'Sample product with a longer name';
}
if (!translations.de['preview-nazov-placeholder']) {
    translations.de['preview-nazov-placeholder'] = 'Beispielprodukt mit l√§ngerem Namen';
}

/**
 * Exportuje datab√°zu do zvolen√©ho form√°tu (CSV, Excel, JSON).
 * @param {string} format - Form√°t exportu ('csv', 'excel', 'json').
 */
function exportDatabase(format) {
    if (database.length === 0) {
        showToast(translations[currentLanguage]['toast-warning-no-data'], 'warning');
        return;
    }

    const dataToExport = database.map(item => ({
        Artikel: item.artikel,
        Nazov: item.nazov,
        Polica: item.polica,
        DatumPridania: item.addedDate || ''
    }));

    const filename = `schaffle_database_${new Date().toISOString().slice(0, 10)}`;

    try {
        if (format === 'csv') {
            const csv = PapaParse.unparse(dataToExport);
            const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' }); // Add BOM for Excel
            downloadBlob(blob, `${filename}.csv`);
        } else if (format === 'excel') {
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Datab√°za");
            XLSX.writeFile(wb, `${filename}.xlsx`);
        } else if (format === 'json') {
            const json = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
            downloadBlob(blob, `${filename}.json`);
        }
        showToast(translations[currentLanguage]['toast-success-export'], 'success');
    } catch (e) {
        console.error("Chyba pri exporte:", e);
        showToast("Nastala chyba pri exporte d√°t.", 'error');
    }
}

/**
 * Pomocn√° funkcia na stiahnutie s√∫boru (Blob).
 * @param {Blob} blob - Blob, ktor√Ω sa m√° stiahnu≈•.
 * @param {string} filename - N√°zov s√∫boru.
 */
function downloadBlob(blob, filename) {
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
}
